---
title: "Azure Active Directory kimlik doğrulaması ve Resource Manager | Microsoft Docs"
description: "Bir uygulama başka Azure abonelikleri ile tümleştirmek için Azure Kaynak Yöneticisi API'si ve Azure Active Directory ile kimlik doğrulaması için bir Geliştirici Kılavuzu."
services: azure-resource-manager,active-directory
documentationcenter: na
author: dushyantgill
manager: timlt
editor: tysonn
ms.assetid: 17b2b40d-bf42-4c7d-9a88-9938409c5088
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/27/2016
ms.author: dugill;tomfitz
ms.openlocfilehash: 7830dc4774652f4d108e98660dce3bcea7b32d05
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 07/11/2017
---
# <a name="use-resource-manager-authentication-api-to-access-subscriptions"></a><span data-ttu-id="6d67f-103">Erişim abonelikler için kaynak yöneticisi kimlik doğrulaması API'sini kullanın</span><span class="sxs-lookup"><span data-stu-id="6d67f-103">Use Resource Manager authentication API to access subscriptions</span></span>
## <a name="introduction"></a><span data-ttu-id="6d67f-104">Giriş</span><span class="sxs-lookup"><span data-stu-id="6d67f-104">Introduction</span></span>
<span data-ttu-id="6d67f-105">Müşterinin Azure kaynaklarını yöneten bir uygulama oluşturmak için gereken bir yazılım geliştirici varsa, bu konuda, Azure Resource Manager API'leri ile kimlik doğrulaması ve diğer abonelikler kaynaklarına erişim kazanmak nasıl gösterir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-105">If you are a software developer who needs to create an app that manages customer's Azure resources, this topic shows you how to authenticate with the Azure Resource Manager APIs and gain access to resources in other subscriptions.</span></span>

<span data-ttu-id="6d67f-106">Uygulamanızı çeşitli şekillerde Resource Manager API'leri erişebilirsiniz:</span><span class="sxs-lookup"><span data-stu-id="6d67f-106">Your app can access the Resource Manager APIs in couple of ways:</span></span>

1. <span data-ttu-id="6d67f-107">**Kullanıcı + uygulama erişimi**: oturum açmış bir kullanıcı adına kaynaklara uygulamalar için.</span><span class="sxs-lookup"><span data-stu-id="6d67f-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span></span> <span data-ttu-id="6d67f-108">Bu yaklaşım, web uygulamaları ve yalnızca "Etkileşimli Yönetimi" Azure kaynakları ile ilgili komut satırı araçları gibi uygulamalar için çalışır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span></span>
2. <span data-ttu-id="6d67f-109">**Yalnızca uygulama erişim**: arka plan programı Hizmetleri ve zamanlanmış işler çalışan uygulamalar için.</span><span class="sxs-lookup"><span data-stu-id="6d67f-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span></span> <span data-ttu-id="6d67f-110">Uygulamanın kimlik kaynaklarına doğrudan erişimi verilir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-110">The app's identity is granted direct access to the resources.</span></span> <span data-ttu-id="6d67f-111">Bu yaklaşım, Azure uzun vadeli gözetimsiz (katılımsız) erişimi olması gereken uygulamalar için çalışır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-111">This approach works for apps that need long-term headless (unattended) access to Azure.</span></span>

<span data-ttu-id="6d67f-112">Bu konu, her iki yetkilendirme yöntemi kullanan bir uygulama oluşturmak için adım adım yönergeler sağlar.</span><span class="sxs-lookup"><span data-stu-id="6d67f-112">This topic provides step-by-step instructions to create an app that employs both these authorization methods.</span></span> <span data-ttu-id="6d67f-113">REST API veya C# ile her adımı gerçekleştirmek nasıl gösterir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-113">It shows how to perform each step with REST API or C#.</span></span> <span data-ttu-id="6d67f-114">Tam bir ASP.NET MVC uygulaması şu adresten edinilebilir [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span><span class="sxs-lookup"><span data-stu-id="6d67f-114">The complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span></span>

## <a name="what-the-web-app-does"></a><span data-ttu-id="6d67f-115">Web uygulaması yaptığı</span><span class="sxs-lookup"><span data-stu-id="6d67f-115">What the web app does</span></span>
<span data-ttu-id="6d67f-116">Web uygulaması:</span><span class="sxs-lookup"><span data-stu-id="6d67f-116">The web app:</span></span>

1. <span data-ttu-id="6d67f-117">Bir Azure kullanıcı oturum açtığında.</span><span class="sxs-lookup"><span data-stu-id="6d67f-117">Signs-in an Azure user.</span></span>
2. <span data-ttu-id="6d67f-118">Kaynak Yöneticisi için web uygulaması erişimi vermek için kullanıcıya sorar.</span><span class="sxs-lookup"><span data-stu-id="6d67f-118">Asks user to grant the web app access to Resource Manager.</span></span>
3. <span data-ttu-id="6d67f-119">Resource Manager erişmek için kullanıcı + uygulama erişim belirtecini alır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-119">Gets user + app access token for accessing Resource Manager.</span></span>
4. <span data-ttu-id="6d67f-120">Resource Manager çağırın ve uygulamanın hizmet sorumlusu Abonelikteki aboneliğine uygulama uzun vadeli erişim sağlayan bir rol atamak için belirtecinden (3. adım) kullanır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-120">Uses token (from step 3) to call Resource Manager and assign the app's service principal to a role in the subscription, which gives the app long-term access to the subscription.</span></span>
5. <span data-ttu-id="6d67f-121">Yalnızca uygulama erişim belirtecini alır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-121">Gets app-only access token.</span></span>
6. <span data-ttu-id="6d67f-122">Kaynak Yöneticisi'ni abonelik alanındaki kaynakları yönetmek için belirtecinden (5. adım) kullanır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-122">Uses token (from step 5) to manage resources in the subscription through Resource Manager.</span></span>

<span data-ttu-id="6d67f-123">Web uygulamasının uçtan uca akışı aşağıda verilmiştir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-123">Here's the end-to-end flow of the web application.</span></span>

![Kaynak Yöneticisi kimlik doğrulama akışı](./media/resource-manager-api-authentication/Auth-Swim-Lane.png)

<span data-ttu-id="6d67f-125">Bir kullanıcı olarak kullanmak istediğiniz aboneliği için abonelik kimliğini sağlar:</span><span class="sxs-lookup"><span data-stu-id="6d67f-125">As a user, you provide the subscription id for the subscription you want to use:</span></span>

![Abonelik kimliği sağlayın](./media/resource-manager-api-authentication/sample-ux-1.png)

<span data-ttu-id="6d67f-127">Oturum açma için kullanılacak hesabı seçin.</span><span class="sxs-lookup"><span data-stu-id="6d67f-127">Select the account to use for logging in.</span></span>

![hesabı seçin](./media/resource-manager-api-authentication/sample-ux-2.png)

<span data-ttu-id="6d67f-129">Kimlik bilgilerinizi sağlayın.</span><span class="sxs-lookup"><span data-stu-id="6d67f-129">Provide your credentials.</span></span>

![kimlik bilgilerini sağlayın](./media/resource-manager-api-authentication/sample-ux-3.png)

<span data-ttu-id="6d67f-131">Azure aboneliklerinize uygulama erişimi verin:</span><span class="sxs-lookup"><span data-stu-id="6d67f-131">Grant the app access to your Azure subscriptions:</span></span>

![Erişim verme](./media/resource-manager-api-authentication/sample-ux-4.png)

<span data-ttu-id="6d67f-133">Bağlı aboneliklerinizi yönetin:</span><span class="sxs-lookup"><span data-stu-id="6d67f-133">Manage your connected subscriptions:</span></span>

![Abonelik Bağlan](./media/resource-manager-api-authentication/sample-ux-7.png)

## <a name="register-application"></a><span data-ttu-id="6d67f-135">Uygulamayı Kaydet</span><span class="sxs-lookup"><span data-stu-id="6d67f-135">Register application</span></span>
<span data-ttu-id="6d67f-136">Kodlama başlamadan önce web uygulamanızı Azure Active Directory (AD ile) kaydedin.</span><span class="sxs-lookup"><span data-stu-id="6d67f-136">Before you start coding, register your web app with Azure Active Directory (AD).</span></span> <span data-ttu-id="6d67f-137">Uygulama Kayıt Merkezi Kimliği uygulamanız için Azure AD içinde oluşturur.</span><span class="sxs-lookup"><span data-stu-id="6d67f-137">The app registration creates a central identity for your app in Azure AD.</span></span> <span data-ttu-id="6d67f-138">Uygulamanız OAuth istemci kimliği, yanıt URL'leri ve uygulamanızın kimlik doğrulaması ve Azure Resource Manager API'leri erişmek için kullandığı kimlik bilgileri gibi hakkındaki temel bilgileri tutar.</span><span class="sxs-lookup"><span data-stu-id="6d67f-138">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses to authenticate and access Azure Resource Manager APIs.</span></span> <span data-ttu-id="6d67f-139">Uygulama kaydı ayrıca Microsoft APIs kullanıcı adına erişirken uygulamanız gereken çeşitli izinlere temsilci kaydeder.</span><span class="sxs-lookup"><span data-stu-id="6d67f-139">The app registration also records the various delegated permissions that your application needs when accessing Microsoft APIs on behalf of the user.</span></span>

<span data-ttu-id="6d67f-140">Uygulamanızı diğer abonelik eriştiği için bir çok kiracılı uygulama olarak yapılandırmanız gerekir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-140">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span></span> <span data-ttu-id="6d67f-141">Doğrulama geçirmek için Azure Active Directory ile ilişkilendirilmiş bir etki alanı sağlar.</span><span class="sxs-lookup"><span data-stu-id="6d67f-141">To pass validation, provide a domain associated with your Azure Active Directory.</span></span> <span data-ttu-id="6d67f-142">Azure Active Directory ile ilişkili etki alanları görmek için oturum [Klasik portal](https://manage.windowsazure.com).</span><span class="sxs-lookup"><span data-stu-id="6d67f-142">To see the domains associated with your Azure Active Directory, log in to the [classic portal](https://manage.windowsazure.com).</span></span> <span data-ttu-id="6d67f-143">Azure Active Directory'yi seçin ve ardından **etki alanları**.</span><span class="sxs-lookup"><span data-stu-id="6d67f-143">Select your Azure Active Directory and then select **Domains**.</span></span>

<span data-ttu-id="6d67f-144">Aşağıdaki örnek, Azure PowerShell kullanarak uygulamayı kaydedin gösterilmektedir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-144">The following example shows how to register the app by using Azure PowerShell.</span></span> <span data-ttu-id="6d67f-145">Bu komutun çalışması Azure PowerShell'in en son sürümünü (Ağustos 2016) olması gerekir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-145">You must have the latest version (August 2016) of Azure PowerShell for this command to work.</span></span>

    $app = New-AzureRmADApplication -DisplayName "{app name}" -HomePage "https://{your domain}/{app name}" -IdentifierUris "https://{your domain}/{app name}" -Password "{your password}" -AvailableToOtherTenants $true

<span data-ttu-id="6d67f-146">AD uygulaması olarak oturum açmak için uygulama kimliği ve parola gerekir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-146">To log in as the AD application, you need the application id and password.</span></span> <span data-ttu-id="6d67f-147">Önceki komutu döndürülen uygulama kimliği görmek için kullanın:</span><span class="sxs-lookup"><span data-stu-id="6d67f-147">To see the application id that is returned from the previous command, use:</span></span>

    $app.ApplicationId

<span data-ttu-id="6d67f-148">Aşağıdaki örnek, Azure CLI kullanarak uygulamanızı kaydetmeniz gösterilmektedir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-148">The following example shows how to register the app by using Azure CLI.</span></span>

    azure ad app create --name {app name} --home-page https://{your domain}/{app name} --identifier-uris https://{your domain}/{app name} --password {your password} --available true

<span data-ttu-id="6d67f-149">Sonuç olarak uygulamadan doğrulanırken ihtiyacınız AppID içerir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-149">The results include the AppId, which you need when authenticating as the application.</span></span>

### <a name="optional-configuration---certificate-credential"></a><span data-ttu-id="6d67f-150">İsteğe bağlı yapılandırma - sertifika kimlik bilgisi</span><span class="sxs-lookup"><span data-stu-id="6d67f-150">Optional configuration - certificate credential</span></span>
<span data-ttu-id="6d67f-151">Azure AD uygulamaları için de sertifika kimlik bilgileri destekler: otomatik olarak imzalanan sertifika oluştur, özel anahtarı tutmak ve Azure AD uygulama kaydınızı ortak anahtarı ekleyin.</span><span class="sxs-lookup"><span data-stu-id="6d67f-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep the private key, and add the public key to your Azure AD application registration.</span></span> <span data-ttu-id="6d67f-152">Kimlik doğrulaması, uygulamanızın küçük bir yükü özel anahtarınızı kullanarak imzalanmış Azure AD ile gönderir ve Azure AD kaydettiğiniz ortak anahtar kullanarak imzayı doğrular.</span><span class="sxs-lookup"><span data-stu-id="6d67f-152">For authentication, your application sends a small payload to Azure AD signed using your private key, and Azure AD validates the signature using the public key that you registered.</span></span>

<span data-ttu-id="6d67f-153">Bir sertifika ile AD uygulaması oluşturma hakkında daha fazla bilgi için bkz: [kaynaklara erişmek için bir hizmet sorumlusu oluşturmak için kullanım Azure PowerShell](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) veya [kaynaklara erişmek için bir hizmet sorumlusu oluşturmak için kullanım Azure CLI](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate) .</span><span class="sxs-lookup"><span data-stu-id="6d67f-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell to create a service principal to access resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI to create a service principal to access resources](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span></span>

## <a name="get-tenant-id-from-subscription-id"></a><span data-ttu-id="6d67f-154">Abonelik kimliği Kiracı kimliğinizi alma</span><span class="sxs-lookup"><span data-stu-id="6d67f-154">Get tenant id from subscription id</span></span>
<span data-ttu-id="6d67f-155">Resource Manager çağırmak için kullanılabilecek bir belirteç istemek için uygulamanızı Azure aboneliği barındıran Azure AD kiracısı Kiracı kimliği bilmek ister.</span><span class="sxs-lookup"><span data-stu-id="6d67f-155">To request a token that can be used to call Resource Manager, your application needs to know the tenant ID of the Azure AD tenant that hosts the Azure subscription.</span></span> <span data-ttu-id="6d67f-156">Büyük olasılıkla, kullanıcılarınızın abonelik kimlikleri biliyorum, ancak bunlar kendi Kiracı kimlikleri için Azure Active Directory anlamayabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="6d67f-156">Most likely, your users know their subscription ids, but they might not know their tenant ids for Azure Active Directory.</span></span> <span data-ttu-id="6d67f-157">Kullanıcının Kiracı Kimliği almak için abonelik kimliği için kullanıcı isteyin.</span><span class="sxs-lookup"><span data-stu-id="6d67f-157">To get the user's tenant id, ask the user for the subscription id.</span></span> <span data-ttu-id="6d67f-158">Bu abonelik kimliği, abonelik ilgili bir istek gönderirken sağlar:</span><span class="sxs-lookup"><span data-stu-id="6d67f-158">Provide that subscription id when sending a request about the subscription:</span></span>

    https://management.azure.com/subscriptions/{subscription-id}?api-version=2015-01-01

<span data-ttu-id="6d67f-159">Kullanıcı henüz oturum açtıktan değil, ancak Kiracı kimliği gelen yanıt almak için isteği başarısız olur.</span><span class="sxs-lookup"><span data-stu-id="6d67f-159">The request fails because the user has not logged in yet, but you can retrieve the tenant id from the response.</span></span> <span data-ttu-id="6d67f-160">Bu durum, yanıt üstbilgi değeri Kiracı Kimliği almak **WWW-Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="6d67f-160">In that exception, retrieve the tenant id from the response header value for **WWW-Authenticate**.</span></span> <span data-ttu-id="6d67f-161">Bu uygulamasında gördüğünüz [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) yöntemi.</span><span class="sxs-lookup"><span data-stu-id="6d67f-161">You see this implementation in the [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span></span>

## <a name="get-user--app-access-token"></a><span data-ttu-id="6d67f-162">Kullanıcı + uygulama erişim belirteci alın</span><span class="sxs-lookup"><span data-stu-id="6d67f-162">Get user + app access token</span></span>
<span data-ttu-id="6d67f-163">Uygulamanızı Azure AD ile bir OAuth 2.0 yetkilendirme kullanıcının kimlik bilgilerini doğrulamak ve bir kimlik doğrulama kodu geri alma isteği - kullanıcı yönlendirir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-163">Your application redirects the user to Azure AD with an OAuth 2.0 Authorize Request - to authenticate the user's credentials and get back an authorization code.</span></span> <span data-ttu-id="6d67f-164">Uygulamanız, kaynak yöneticisi için bir erişim belirteci almak için yetki kodunu kullanır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-164">Your application uses the authorization code to get an access token for Resource Manager.</span></span> <span data-ttu-id="6d67f-165">[ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) yöntemi, yetkilendirme isteği oluşturur.</span><span class="sxs-lookup"><span data-stu-id="6d67f-165">The [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates the authorization request.</span></span>

<span data-ttu-id="6d67f-166">Bu konu, kullanıcının kimliğini doğrulamak için REST API istekleri gösterir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-166">This topic shows the REST API requests to authenticate the user.</span></span> <span data-ttu-id="6d67f-167">Kodunuzda kimlik doğrulaması yapmak için yardımcı kitaplıkları da kullanabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="6d67f-167">You can also use helper libraries to perform authentication in your code.</span></span> <span data-ttu-id="6d67f-168">Bu kitaplıklar hakkında daha fazla bilgi için bkz: [Azure Active Directory kimlik doğrulama kitaplıkları](../active-directory/active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="6d67f-168">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span></span> <span data-ttu-id="6d67f-169">Kimlik Yönetimi uygulamada tümleştirme ile ilgili yönergeler için bkz: [Azure Active Directory Geliştirici Kılavuzu](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="6d67f-169">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/active-directory-developers-guide.md).</span></span>

### <a name="auth-request-oauth-20"></a><span data-ttu-id="6d67f-170">Kimlik doğrulama isteği (OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="6d67f-170">Auth request (OAuth 2.0)</span></span>
<span data-ttu-id="6d67f-171">Bir açık Bağlan/OAuth2.0 yetkilendirmek istek kimliği için Azure AD Authorize son noktası yürütün:</span><span class="sxs-lookup"><span data-stu-id="6d67f-171">Issue an Open ID Connect/OAuth2.0 Authorize Request to the Azure AD Authorize endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize

<span data-ttu-id="6d67f-172">Bu istek için sorgu dizesi parametreleri açıklanan [bir kimlik doğrulama kodu isteme](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) konu.</span><span class="sxs-lookup"><span data-stu-id="6d67f-172">The query string parameters that are available for this request are described in the [request an authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) topic.</span></span>

<span data-ttu-id="6d67f-173">Aşağıdaki örnek, OAuth2.0 yetkilendirme isteği gösterilmektedir:</span><span class="sxs-lookup"><span data-stu-id="6d67f-173">The following example shows how to request OAuth2.0 authorization:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=query&response_type=code&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&domain_hint=live.com

<span data-ttu-id="6d67f-174">Azure AD kullanıcının kimliğini doğrular ve gerekirse, uygulama izni vermek için kullanıcıya sorar.</span><span class="sxs-lookup"><span data-stu-id="6d67f-174">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="6d67f-175">Bu, uygulamanızın yanıt URL'si için yetkilendirme kodu döndürür.</span><span class="sxs-lookup"><span data-stu-id="6d67f-175">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="6d67f-176">Azure AD istenen response_mode ya da bağlı olarak geri verileri sorgu dizesi veya gönderme verisi olarak gönderir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-176">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

    code=AAABAAAAiL****FDMZBUwZ8eCAA&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="auth-request-open-id-connect"></a><span data-ttu-id="6d67f-177">Kimlik doğrulama isteği (Open ID Connect)</span><span class="sxs-lookup"><span data-stu-id="6d67f-177">Auth request (Open ID Connect)</span></span>
<span data-ttu-id="6d67f-178">Bir açık bağlanma yetkisi istek kimliği yalnızca Azure kaynak yöneticisi kullanıcı adına erişmek istediğiniz, ancak Ayrıca, uygulamanız kendi Azure AD hesabı kullanarak oturum açmak kullanıcının izin verin.</span><span class="sxs-lookup"><span data-stu-id="6d67f-178">If you not only wish to access Azure Resource Manager on behalf of the user, but also allow the user to sign in to your application using their Azure AD account, issue an Open ID Connect Authorize Request.</span></span> <span data-ttu-id="6d67f-179">Open ID Connect ile uygulamanızı uygulamanızı kullanıcıyla oturum açmak için kullanabileceğiniz Azure AD'den bir id_token de alır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-179">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use to sign in the user.</span></span>

<span data-ttu-id="6d67f-180">Bu istek için sorgu dizesi parametreleri açıklanan [oturum açma isteği Gönder](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) konu.</span><span class="sxs-lookup"><span data-stu-id="6d67f-180">The query string parameters that are available for this request are described in the [Send the sign-in request](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) topic.</span></span>

<span data-ttu-id="6d67f-181">Bir örnek Open ID Connect isteğidir:</span><span class="sxs-lookup"><span data-stu-id="6d67f-181">An example Open ID Connect request is:</span></span>

     https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=form_post&response_type=code+id_token&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&scope=openid+profile&nonce=63567Dc4MDAw&domain_hint=live.com&state=M_12tMyKaM8

<span data-ttu-id="6d67f-182">Azure AD kullanıcının kimliğini doğrular ve gerekirse, uygulama izni vermek için kullanıcıya sorar.</span><span class="sxs-lookup"><span data-stu-id="6d67f-182">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="6d67f-183">Bu, uygulamanızın yanıt URL'si için yetkilendirme kodu döndürür.</span><span class="sxs-lookup"><span data-stu-id="6d67f-183">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="6d67f-184">Azure AD istenen response_mode ya da bağlı olarak geri verileri sorgu dizesi veya gönderme verisi olarak gönderir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-184">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

<span data-ttu-id="6d67f-185">Open ID Connect yanıt örneğidir:</span><span class="sxs-lookup"><span data-stu-id="6d67f-185">An example Open ID Connect response is:</span></span>

    code=AAABAAAAiL*****I4rDWd7zXsH6WUjlkIEQxIAA&id_token=eyJ0eXAiOiJKV1Q*****T3GrzzSFxg&state=M_12tMyKaM8&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="token-request-oauth20-code-grant-flow"></a><span data-ttu-id="6d67f-186">Belirteç isteği (OAuth2.0 kod Grant akış)</span><span class="sxs-lookup"><span data-stu-id="6d67f-186">Token request (OAuth2.0 Code Grant Flow)</span></span>
<span data-ttu-id="6d67f-187">Uygulamanızı Azure AD'den yetkilendirme kodu aldı, Azure kaynak yöneticisi için erişim belirteci almak için zaman yapılır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-187">Now that your application has received the authorization code from Azure AD, it is time to get the access token for Azure Resource Manager.</span></span>  <span data-ttu-id="6d67f-188">Bir OAuth2.0 kod Grant belirteç isteği Azure AD belirteç uç noktası gönderin:</span><span class="sxs-lookup"><span data-stu-id="6d67f-188">Post an OAuth2.0 Code Grant Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="6d67f-189">Bu istek için sorgu dizesi parametreleri açıklanan [yetkilendirme kodu kullanın](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) konu.</span><span class="sxs-lookup"><span data-stu-id="6d67f-189">The query string parameters that are available for this request are described in the [use the authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) topic.</span></span>

<span data-ttu-id="6d67f-190">Aşağıdaki örnek kod grant belirteci parola kimlik bilgisi için bir istek gösterir:</span><span class="sxs-lookup"><span data-stu-id="6d67f-190">The following example shows a request for code grant token with password credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="6d67f-191">Sertifika kimlik bilgileri ile çalışırken, bir JSON Web Token (JWT) ve uygulamanızın sertifika kimlik bilgisi özel anahtarı kullanılarak oturum (RSA SHA256) oluşturun.</span><span class="sxs-lookup"><span data-stu-id="6d67f-191">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using the private key of your application's certificate credential.</span></span> <span data-ttu-id="6d67f-192">Belirteç için talep türleri gösterilmektedir [JWT belirteci taleplerini](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span><span class="sxs-lookup"><span data-stu-id="6d67f-192">The claim types for the token are shown in [JWT token claims](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span></span> <span data-ttu-id="6d67f-193">Başvuru için bkz: [Active Directory kimlik doğrulama kitaplığı (.NET) kod](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) istemci onaylama JWT Belirteçleri imzalamak için.</span><span class="sxs-lookup"><span data-stu-id="6d67f-193">For reference, see the [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) to sign Client Assertion JWT tokens.</span></span>

<span data-ttu-id="6d67f-194">Bkz: [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) istemci kimlik doğrulaması hakkında ayrıntılı bilgi için.</span><span class="sxs-lookup"><span data-stu-id="6d67f-194">See the [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span></span>

<span data-ttu-id="6d67f-195">Aşağıdaki örnek kod grant belirteciyle sertifika kimlik bilgisi için bir istek gösterir:</span><span class="sxs-lookup"><span data-stu-id="6d67f-195">The following example shows a request for code grant token with certificate credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&client_assertion=eyJhbG*****Y9cYo8nEjMyA

<span data-ttu-id="6d67f-196">Bir örnek yanıt kodu için belirteç verin:</span><span class="sxs-lookup"><span data-stu-id="6d67f-196">An example response for code grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039858","not_before":"1432035958","resource":"https://management.core.windows.net/","access_token":"eyJ0eXAiOiJKV1Q****M7Cw6JWtfY2lGc5A","refresh_token":"AAABAAAAiL9Kn2Z****55j-sjnyYgAA","scope":"user_impersonation","id_token":"eyJ0eXAiOiJKV*****-drP1J3P-HnHi9Rr46kGZnukEBH4dsg"}

#### <a name="handle-code-grant-token-response"></a><span data-ttu-id="6d67f-197">Kod grant belirteç yanıtı işlemek</span><span class="sxs-lookup"><span data-stu-id="6d67f-197">Handle code grant token response</span></span>
<span data-ttu-id="6d67f-198">Başarılı bir token yanıt içerir (kullanıcı + uygulama) erişim belirteci için Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="6d67f-198">A successful token response contains the (user + app) access token for Azure Resource Manager.</span></span> <span data-ttu-id="6d67f-199">Uygulamanız bu erişim belirteci kullanıcı adına Kaynak Yöneticisi'ne erişmek için kullanır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-199">Your application uses this access token to access Resource Manager on behalf of the user.</span></span> <span data-ttu-id="6d67f-200">Azure AD tarafından verilen erişim belirteçleri süresi bir saattir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-200">The lifetime of access tokens issued by Azure AD is one hour.</span></span> <span data-ttu-id="6d67f-201">Web uygulamanız (kullanıcı + uygulama) yenilemek için ihtiyaç duyduğu düşüktür erişim belirteci.</span><span class="sxs-lookup"><span data-stu-id="6d67f-201">It is unlikely that your web application needs to renew the (user + app) access token.</span></span> <span data-ttu-id="6d67f-202">Erişim belirteci yenilemeye gerektiriyorsa, uygulamanızın içinde belirteç yanıtı alır yenileme belirteci kullanın.</span><span class="sxs-lookup"><span data-stu-id="6d67f-202">If it needs to renew the access token, use the refresh token that your application receives in the token response.</span></span> <span data-ttu-id="6d67f-203">Bir OAuth2.0 belirteci isteği Azure AD belirteç uç noktası gönderin:</span><span class="sxs-lookup"><span data-stu-id="6d67f-203">Post an OAuth2.0 Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="6d67f-204">İle yenileme isteği kullanılacak parametreleri açıklanan [erişim belirtecini yenilemeyi](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span><span class="sxs-lookup"><span data-stu-id="6d67f-204">The parameters to use with the refresh request are described in [refreshing the access token](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span></span>

<span data-ttu-id="6d67f-205">Aşağıdaki örnek yenilemeyi kullanmak belirteci gösterilmektedir:</span><span class="sxs-lookup"><span data-stu-id="6d67f-205">The following example shows how to use the refresh token:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=refresh_token&refresh_token=AAABAAAAiL9Kn2Z****55j-sjnyYgAA&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="6d67f-206">Yenileme belirteçleri, Azure Resource Manager için yeni erişim belirteçleri almak için kullanılır ancak bunlar uygulamanızı çevrimdışı erişmek için uygun değildir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-206">Although refresh tokens can be used to get new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span></span> <span data-ttu-id="6d67f-207">Yenileme belirteçleri ömrü sınırlıdır ve yenileme belirteçleri kullanıcıya bağlıdır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-207">The refresh tokens lifetime is limited, and refresh tokens are bound to the user.</span></span> <span data-ttu-id="6d67f-208">Kullanıcı kuruluş ayrılsa yenileme belirtecini kullanarak uygulama erişim kaybeder.</span><span class="sxs-lookup"><span data-stu-id="6d67f-208">If the user leaves the organization, the application using the refresh token loses access.</span></span> <span data-ttu-id="6d67f-209">Bu yaklaşım ekipleri tarafından Azure kaynaklarını yönetmek için kullanılan uygulamalar için uygun değil.</span><span class="sxs-lookup"><span data-stu-id="6d67f-209">This approach isn't suitable for applications that are used by teams to manage their Azure resources.</span></span>

## <a name="check-if-user-can-assign-access-to-subscription"></a><span data-ttu-id="6d67f-210">Kullanıcı aboneliğe erişimi atayın olmadığını denetleyin</span><span class="sxs-lookup"><span data-stu-id="6d67f-210">Check if user can assign access to subscription</span></span>
<span data-ttu-id="6d67f-211">Uygulamanız artık Azure Resource Manager kullanıcı adına erişmek için bir belirteç sahiptir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-211">Your application now has a token to access Azure Resource Manager on behalf of the user.</span></span> <span data-ttu-id="6d67f-212">Sonraki adım, abonelik uygulamanızı bağlamaktır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-212">The next step is to connect your app to the subscription.</span></span> <span data-ttu-id="6d67f-213">Kullanıcı mevcut değilse bile bağladıktan sonra uygulamanızı bu abonelikleri yönetebilirsiniz (uzun süreli çevrimdışı erişim).</span><span class="sxs-lookup"><span data-stu-id="6d67f-213">After connecting, your app can manage those subscriptions even when the user isn't present (long-term offline access).</span></span>

<span data-ttu-id="6d67f-214">Bağlanmak her abonelik için çağrı [Resource Manager liste izinlerini](https://docs.microsoft.com/rest/api/authorization/permissions) kullanıcı abonelik için erişim yönetim haklarına sahip olup olmadığını belirlemek için API.</span><span class="sxs-lookup"><span data-stu-id="6d67f-214">For each subscription to connect, call the [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API to determine whether the user has access management rights for the subscription.</span></span>

<span data-ttu-id="6d67f-215">[UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) yöntemi ASP.NET MVC örnek uygulaması, bu çağrıyı uygular.</span><span class="sxs-lookup"><span data-stu-id="6d67f-215">The [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of the ASP.NET MVC sample app implements this call.</span></span>

<span data-ttu-id="6d67f-216">Aşağıdaki örnek, bir abonelik bir kullanıcının izinleri istemek gösterilmiştir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-216">The following example shows how to request a user's permissions on a subscription.</span></span> <span data-ttu-id="6d67f-217">83cfe939-2402-4581-b761-4f59b0a041e4 abonelik kimliğini gösterir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-217">83cfe939-2402-4581-b761-4f59b0a041e4 is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/83cfe939-2402-4581-b761-4f59b0a041e4/providers/microsoft.authorization/permissions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiLC***lwO1mM7Cw6JWtfY2lGc5A

<span data-ttu-id="6d67f-218">Abonelik üzerinde kullanıcı izinlerini almak için yanıt örneğidir:</span><span class="sxs-lookup"><span data-stu-id="6d67f-218">An example of the response to get user's permissions on subscription is:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"actions":["*"],"notActions":["Microsoft.Authorization/*/Write","Microsoft.Authorization/*/Delete"]},{"actions":["*/read"],"notActions":[]}]}

<span data-ttu-id="6d67f-219">API izinleri birden çok izin verir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-219">The permissions API returns multiple permissions.</span></span> <span data-ttu-id="6d67f-220">Her izin izin verilen eylemleri (Eylemler) oluşur ve eylemleri (notactions) izin verilmiyor.</span><span class="sxs-lookup"><span data-stu-id="6d67f-220">Each permission consists of allowed actions (actions) and disallowed actions (notactions).</span></span> <span data-ttu-id="6d67f-221">Bir eylem tüm izinleri izin verilen eylemleri listesinde mevcut ve bu izni notactions listesinde yok olduğunda, kullanıcının bu eylemi gerçekleştirmek için izin verilir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-221">If an action is present in the allowed actions list of any permission and not present in the notactions list of that permission, the user is allowed to perform that action.</span></span> <span data-ttu-id="6d67f-222">**Microsoft.Authorization/roleassignments/Write** , erişim yönetim hakları veren eylemdir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-222">**microsoft.authorization/roleassignments/write** is the action that that grants access management rights.</span></span> <span data-ttu-id="6d67f-223">Uygulamanız bu eylem dizesi eylemleri ve her izin notactions bir regex eşleşme aramak için izinleri sonuç ayrıştırma gerekir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-223">Your application must parse the permissions result to look for a regex match on this action string in the actions and notactions of each permission.</span></span>

## <a name="get-app-only-access-token"></a><span data-ttu-id="6d67f-224">Yalnızca uygulama erişim belirteci alma</span><span class="sxs-lookup"><span data-stu-id="6d67f-224">Get app-only access token</span></span>
<span data-ttu-id="6d67f-225">Artık, kullanıcının Azure aboneliğine erişimi atayın, biliyorsunuz.</span><span class="sxs-lookup"><span data-stu-id="6d67f-225">Now, you know if the user can assign access to the Azure subscription.</span></span> <span data-ttu-id="6d67f-226">Sonraki adımlar şunlardır:</span><span class="sxs-lookup"><span data-stu-id="6d67f-226">The next steps are:</span></span>

1. <span data-ttu-id="6d67f-227">Uygulamanızın kimlik aboneliğe ilişkin uygun RBAC rolü atayın.</span><span class="sxs-lookup"><span data-stu-id="6d67f-227">Assign the appropriate RBAC role to your application's identity on the subscription.</span></span>
2. <span data-ttu-id="6d67f-228">Erişim atama abonelik uygulamanın izni sorgulanırken veya Kaynak Yöneticisi'ni yalnızca uygulama belirteci kullanarak erişerek doğrulayın.</span><span class="sxs-lookup"><span data-stu-id="6d67f-228">Validate the access assignment by querying for the Application's permission on the subscription or by accessing Resource Manager using app-only token.</span></span>
3. <span data-ttu-id="6d67f-229">Bağlantının abonelik kimliği sürdürmek, uygulamaları "bağlı abonelikleri" veri yapısında - kaydedin.</span><span class="sxs-lookup"><span data-stu-id="6d67f-229">Record the connection in your applications "connected subscriptions" data structure - persisting the id of the subscription.</span></span>

<span data-ttu-id="6d67f-230">İlk adımda daha yakın olarak bakalım.</span><span class="sxs-lookup"><span data-stu-id="6d67f-230">Let's look closer at the first step.</span></span> <span data-ttu-id="6d67f-231">Uygulamanın kimliğini uygun RBAC rolü atamak için belirlemeniz gerekir:</span><span class="sxs-lookup"><span data-stu-id="6d67f-231">To assign the appropriate RBAC role to the application's identity, you must determine:</span></span>

* <span data-ttu-id="6d67f-232">Uygulamanızın kimlik kullanıcının Azure Active Directory'de nesne kimliği</span><span class="sxs-lookup"><span data-stu-id="6d67f-232">The object id of your application's identity in the user's Azure Active Directory</span></span>
* <span data-ttu-id="6d67f-233">Abonelikte uygulamanızın gerektirdiği RBAC rolü tanıtıcısı</span><span class="sxs-lookup"><span data-stu-id="6d67f-233">The identifier of the RBAC role that your application requires on the subscription</span></span>

<span data-ttu-id="6d67f-234">Uygulamanız bir Azure AD'den bir kullanıcı kimliği doğruladığında, Azure AD'de, uygulamanız için bir hizmet sorumlusu nesnesi oluşturur.</span><span class="sxs-lookup"><span data-stu-id="6d67f-234">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span></span> <span data-ttu-id="6d67f-235">Azure hizmet asıl adı için karşılık gelen uygulamaları Azure kaynaklarına doğrudan erişim vermek üzere atanacak RBAC rolleri sağlar.</span><span class="sxs-lookup"><span data-stu-id="6d67f-235">Azure allows RBAC roles to be assigned to service principals to grant direct access to corresponding applications on Azure resources.</span></span> <span data-ttu-id="6d67f-236">Bu tam olarak yapmak istediğimiz eylemdir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-236">This action is exactly what we wish to do.</span></span> <span data-ttu-id="6d67f-237">Azure AD hizmet sorumlusu oturum açmış kullanıcı, uygulamanızın tanıtıcısı belirlemek için Azure AD Graph API sorgu kullanıcının.</span><span class="sxs-lookup"><span data-stu-id="6d67f-237">Query the Azure AD Graph API to determine the identifier of the service principal of your application in the signed-in user's Azure AD.</span></span>

<span data-ttu-id="6d67f-238">Azure kaynak yöneticisi için yalnızca bir erişim belirteci sahip - Azure AD grafik API'si yi çağırmak için yeni bir erişim belirteci gerekir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-238">You only have an access token for Azure Resource Manager - you need a new access token to call the Azure AD Graph API.</span></span> <span data-ttu-id="6d67f-239">Azure AD her uygulamada yalnızca uygulama erişim belirteci yeterli olacak şekilde, kendi hizmet sorumlusu nesnesi sorgulama izni vardır.</span><span class="sxs-lookup"><span data-stu-id="6d67f-239">Every application in Azure AD has permission to query its own service principal object, so an app-only access token is sufficient.</span></span>

<a id="app-azure-ad-graph" />

### <a name="get-app-only-access-token-for-azure-ad-graph-api"></a><span data-ttu-id="6d67f-240">Yalnızca uygulama erişimi için Azure AD Graph API belirteci alma</span><span class="sxs-lookup"><span data-stu-id="6d67f-240">Get app-only access token for Azure AD Graph API</span></span>
<span data-ttu-id="6d67f-241">Uygulamanıza kimlik doğrulaması ve Azure AD grafik API'si için bir belirteç almak için Azure AD belirteç uç noktası için bir istemci kimlik bilgileri verin OAuth2.0 akış belirteç isteği gönderin (**https://login.microsoftonline.com/ {directory_domain_name} / OAuth2/Token**).</span><span class="sxs-lookup"><span data-stu-id="6d67f-241">To authenticate your app and get a token to Azure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request to Azure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span></span>

<span data-ttu-id="6d67f-242">[GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) yöntemi ASP.net MVC örnek uygulamasının alır yalnızca uygulama erişim belirteci grafik API'si için Active Directory kimlik doğrulama kitaplığı .NET için kullanma.</span><span class="sxs-lookup"><span data-stu-id="6d67f-242">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of the ASP.net MVC sample application gets an app-only access token for Graph API using the Active Directory Authentication Library for .NET.</span></span>

<span data-ttu-id="6d67f-243">Bu istek için sorgu dizesi parametreleri açıklanan [bir erişim belirteci isteği](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) konu.</span><span class="sxs-lookup"><span data-stu-id="6d67f-243">The query string parameters that are available for this request are described in the [Request an Access Token](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) topic.</span></span>

<span data-ttu-id="6d67f-244">İstemci kimlik bilgileri için bir örnek isteği belirteci verin:</span><span class="sxs-lookup"><span data-stu-id="6d67f-244">An example request for client credential grant token:</span></span>

    POST https://login.microsoftonline.com/62e173e9-301e-423e-bcd4-29121ec1aa24/oauth2/token HTTP/1.1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 187</pre>
    <pre>grant_type=client_credentials&client_id=a0448380-c346-4f9f-b897-c18733de9394&resource=https%3A%2F%2Fgraph.windows.net%2F &client_secret=olna8C*****Og%3D

<span data-ttu-id="6d67f-245">İstemci kimlik bilgisi için bir örnek yanıt belirteç verin:</span><span class="sxs-lookup"><span data-stu-id="6d67f-245">An example response for client credential grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039862","not_before":"1432035962","resource":"https://graph.windows.net/","access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRv****G5gUTV-kKorR-pg"}

### <a name="get-objectid-of-application-service-principal-in-user-azure-ad"></a><span data-ttu-id="6d67f-246">Kullanıcı Azure AD uygulama hizmet sorumlusu objectID alın</span><span class="sxs-lookup"><span data-stu-id="6d67f-246">Get ObjectId of application service principal in user Azure AD</span></span>
<span data-ttu-id="6d67f-247">Şimdi, sorgu için yalnızca uygulama erişim belirtecini kullanır [Azure AD grafik hizmet asıl adı](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) dizininde uygulamanın hizmet sorumlusu nesnesi kimliğini belirlemek için API.</span><span class="sxs-lookup"><span data-stu-id="6d67f-247">Now, use the app-only access token to query the [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API to determine the Object Id of the application's service principal in the directory.</span></span>

<span data-ttu-id="6d67f-248">[GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) yöntemi ASP.net MVC örnek uygulamasının bu çağrıyı uygular.</span><span class="sxs-lookup"><span data-stu-id="6d67f-248">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of the ASP.net MVC sample application implements this call.</span></span>

<span data-ttu-id="6d67f-249">Aşağıdaki örnek, bir uygulamanın hizmet asıl istek gösterilmektedir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-249">The following example shows how to request an application's service principal.</span></span> <span data-ttu-id="6d67f-250">a0448380-c346-4f9f-b897-c18733de9394 uygulama istemci kimliğini gösterir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-250">a0448380-c346-4f9f-b897-c18733de9394 is the client id of the application.</span></span>

    GET https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/servicePrincipals?api-version=1.5&$filter=appId%20eq%20'a0448380-c346-4f9f-b897-c18733de9394' HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJK*****-kKorR-pg

<span data-ttu-id="6d67f-251">Aşağıdaki örnek, bir uygulamanın hizmet isteğine yanıt asıl gösterir</span><span class="sxs-lookup"><span data-stu-id="6d67f-251">The following example shows a response to the request for an application's service principal</span></span>

    HTTP/1.1 200 OK

    {"odata.metadata":"https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/$metadata#directoryObjects/Microsoft.DirectoryServices.ServicePrincipal","value":[{"odata.type":"Microsoft.DirectoryServices.ServicePrincipal","objectType":"ServicePrincipal","objectId":"9b5018d4-6951-42ed-8a92-f11ec283ccec","deletionTimestamp":null,"accountEnabled":true,"appDisplayName":"CloudSense","appId":"a0448380-c346-4f9f-b897-c18733de9394","appOwnerTenantId":"62e173e9-301e-423e-bcd4-29121ec1aa24","appRoleAssignmentRequired":false,"appRoles":[],"displayName":"CloudSense","errorUrl":null,"homepage":"http://www.vipswapper.com/cloudsense","keyCredentials":[],"logoutUrl":null,"oauth2Permissions":[{"adminConsentDescription":"Allow the application to access CloudSense on behalf of the signed-in user.","adminConsentDisplayName":"Access CloudSense","id":"b7b7338e-683a-4796-b95e-60c10380de1c","isEnabled":true,"type":"User","userConsentDescription":"Allow the application to access CloudSense on your behalf.","userConsentDisplayName":"Access CloudSense","value":"user_impersonation"}],"passwordCredentials":[],"preferredTokenSigningKeyThumbprint":null,"publisherName":"vipswapper"quot;,"replyUrls":["http://www.vipswapper.com/cloudsense","http://www.vipswapper.com","http://vipswapper.com","http://vipswapper.azurewebsites.net","http://localhost:62080"],"samlMetadataUrl":null,"servicePrincipalNames":["http://www.vipswapper.com/cloudsense","a0448380-c346-4f9f-b897-c18733de9394"],"tags":["WindowsAzureActiveDirectoryIntegratedApp"]}]}

### <a name="get-azure-rbac-role-identifier"></a><span data-ttu-id="6d67f-252">Azure RBAC rolü tanımlayıcısını alın</span><span class="sxs-lookup"><span data-stu-id="6d67f-252">Get Azure RBAC role identifier</span></span>
<span data-ttu-id="6d67f-253">Hizmet sorumlusu uygun RBAC rolü atamak için Azure RBAC rolü tanıtıcısı belirlemeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-253">To assign the appropriate RBAC role to your service principal, you must determine the identifier of the Azure RBAC role.</span></span>

<span data-ttu-id="6d67f-254">Uygulamanız için uygun RBAC rolü:</span><span class="sxs-lookup"><span data-stu-id="6d67f-254">The right RBAC role for your application:</span></span>

* <span data-ttu-id="6d67f-255">Yalnızca uygulamanızı herhangi bir değişiklik yapmadan abonelik izler, yalnızca abonelik okuyucusu izinleri gerektirir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-255">If your application only monitors the subscription, without making any changes, it requires only reader permissions on the subscription.</span></span> <span data-ttu-id="6d67f-256">Ata **okuyucu** rol.</span><span class="sxs-lookup"><span data-stu-id="6d67f-256">Assign the **Reader** role.</span></span>
* <span data-ttu-id="6d67f-257">Uygulamanızı Azure varlıkları oluşturma/değiştirme/silme, abonelik yönetiyorsa katkıda bulunan izinleri birini gerektirir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-257">If your application manages Azure the subscription, creating/modifying/deleting entities, it requires one of the contributor permissions.</span></span>
  * <span data-ttu-id="6d67f-258">Belirli bir kaynak türünü yönetmek için kaynak özgü katkıda bulunan rollerinin (sanal makine Katılımcısı, sanal ağ Katılımcısı, depolama hesabı katkıda bulunan, vb.) atayın.</span><span class="sxs-lookup"><span data-stu-id="6d67f-258">To manage a particular type of resource, assign the resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span></span>
  * <span data-ttu-id="6d67f-259">Herhangi bir kaynak türü yönetmek için Ata **katkıda bulunan** rol.</span><span class="sxs-lookup"><span data-stu-id="6d67f-259">To manage any resource type, assign the **Contributor** role.</span></span>

<span data-ttu-id="6d67f-260">Uygulamanız için rol ataması, böylece select en az gereken ayrıcalık kullanıcılara görünür olur.</span><span class="sxs-lookup"><span data-stu-id="6d67f-260">The role assignment for your application is visible to users, so select the least-required privilege.</span></span>

<span data-ttu-id="6d67f-261">Çağrı [Kaynağı Yöneticisi rol tanımı API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) tüm Azure RBAC rolleri ve arama listesi sonra istenen rol tanımı ada göre bulmak için sonuç üzerinden yineleme.</span><span class="sxs-lookup"><span data-stu-id="6d67f-261">Call the [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) to list all Azure RBAC roles and search then iterate over the result to find the desired role definition by name.</span></span>

<span data-ttu-id="6d67f-262">[GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) yöntemi ASP.net MVC örnek uygulaması, bu çağrıyı uygular.</span><span class="sxs-lookup"><span data-stu-id="6d67f-262">The [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="6d67f-263">Aşağıdaki isteği örnek Azure RBAC rolü tanımlayıcı alma gösterir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-263">The following request example shows how to get Azure RBAC role identifier.</span></span> <span data-ttu-id="6d67f-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb abonelik kimliğini gösterir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV*****fY2lGc5

<span data-ttu-id="6d67f-265">Yanıt şu biçimdedir:</span><span class="sxs-lookup"><span data-stu-id="6d67f-265">The response is in the following format:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"properties":{"roleName":"API Management Service Contributor","type":"BuiltInRole","description":"Lets you manage API Management services, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.ApiManagement/Services/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/312a565d-c81f-4fd8-895a-4e21e48d571c","type":"Microsoft.Authorization/roleDefinitions","name":"312a565d-c81f-4fd8-895a-4e21e48d571c"},{"properties":{"roleName":"Application Insights Component Contributor","type":"BuiltInRole","description":"Lets you manage Application Insights components, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.Insights/components/*","Microsoft.Insights/webtests/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/ae349356-3a1b-4a5e-921d-050484c6347e","type":"Microsoft.Authorization/roleDefinitions","name":"ae349356-3a1b-4a5e-921d-050484c6347e"}]}

<span data-ttu-id="6d67f-266">Sürekli olarak bu API çağrısı gerekmez.</span><span class="sxs-lookup"><span data-stu-id="6d67f-266">You do not need to call this API on an ongoing basis.</span></span> <span data-ttu-id="6d67f-267">Rol tanımı iyi bilinen GUID saptadıktan sonra rol tanımı kimliği olarak oluşturabileceğiniz:</span><span class="sxs-lookup"><span data-stu-id="6d67f-267">Once you've determined the well-known GUID of the role definition, you can construct the role definition id as:</span></span>

    /subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{well-known-role-guid}

<span data-ttu-id="6d67f-268">Yaygın olarak kullanılan yerleşik roller iyi bilinen GUID'lerini şunlardır:</span><span class="sxs-lookup"><span data-stu-id="6d67f-268">Here are the well-known guids of commonly used built-in roles:</span></span>

| <span data-ttu-id="6d67f-269">Rol</span><span class="sxs-lookup"><span data-stu-id="6d67f-269">Role</span></span> | <span data-ttu-id="6d67f-270">GUID</span><span class="sxs-lookup"><span data-stu-id="6d67f-270">Guid</span></span> |
| --- | --- |
| <span data-ttu-id="6d67f-271">Okuyucu</span><span class="sxs-lookup"><span data-stu-id="6d67f-271">Reader</span></span> |<span data-ttu-id="6d67f-272">acdd72a7-3385-48EF-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="6d67f-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |
| <span data-ttu-id="6d67f-273">Katılımcı</span><span class="sxs-lookup"><span data-stu-id="6d67f-273">Contributor</span></span> |<span data-ttu-id="6d67f-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span><span class="sxs-lookup"><span data-stu-id="6d67f-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span></span> |
| <span data-ttu-id="6d67f-275">Sanal makine Katılımcısı</span><span class="sxs-lookup"><span data-stu-id="6d67f-275">Virtual Machine Contributor</span></span> |<span data-ttu-id="6d67f-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span><span class="sxs-lookup"><span data-stu-id="6d67f-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span></span> |
| <span data-ttu-id="6d67f-277">Sanal ağ Katılımcısı</span><span class="sxs-lookup"><span data-stu-id="6d67f-277">Virtual Network Contributor</span></span> |<span data-ttu-id="6d67f-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span><span class="sxs-lookup"><span data-stu-id="6d67f-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span></span> |
| <span data-ttu-id="6d67f-279">Depolama hesabı katkıda bulunan</span><span class="sxs-lookup"><span data-stu-id="6d67f-279">Storage Account Contributor</span></span> |<span data-ttu-id="6d67f-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span><span class="sxs-lookup"><span data-stu-id="6d67f-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span></span> |
| <span data-ttu-id="6d67f-281">Web sitesi katkıda bulunan</span><span class="sxs-lookup"><span data-stu-id="6d67f-281">Website Contributor</span></span> |<span data-ttu-id="6d67f-282">de139f84-1756-47ae-9be6-808fbbe84772</span><span class="sxs-lookup"><span data-stu-id="6d67f-282">de139f84-1756-47ae-9be6-808fbbe84772</span></span> |
| <span data-ttu-id="6d67f-283">Web planı katkıda bulunan</span><span class="sxs-lookup"><span data-stu-id="6d67f-283">Web Plan Contributor</span></span> |<span data-ttu-id="6d67f-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span><span class="sxs-lookup"><span data-stu-id="6d67f-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span></span> |
| <span data-ttu-id="6d67f-285">SQL Server katkıda bulunan</span><span class="sxs-lookup"><span data-stu-id="6d67f-285">SQL Server Contributor</span></span> |<span data-ttu-id="6d67f-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span><span class="sxs-lookup"><span data-stu-id="6d67f-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span></span> |
| <span data-ttu-id="6d67f-287">SQL DB Katılımcısı</span><span class="sxs-lookup"><span data-stu-id="6d67f-287">SQL DB Contributor</span></span> |<span data-ttu-id="6d67f-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span><span class="sxs-lookup"><span data-stu-id="6d67f-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span></span> |

### <a name="assign-rbac-role-to-application"></a><span data-ttu-id="6d67f-289">Uygulama için RBAC rolü atama</span><span class="sxs-lookup"><span data-stu-id="6d67f-289">Assign RBAC role to application</span></span>
<span data-ttu-id="6d67f-290">Kullanarak hizmet sorumlusuna uygun RBAC rolü atamak için ihtiyaç duyduğunuz her şeyi sahip [Kaynağı Yöneticisi rol ataması oluşturma](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span><span class="sxs-lookup"><span data-stu-id="6d67f-290">You have everything you need to assign the appropriate RBAC role to your service principal by using the [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span></span>

<span data-ttu-id="6d67f-291">[GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) yöntemi ASP.net MVC örnek uygulaması, bu çağrıyı uygular.</span><span class="sxs-lookup"><span data-stu-id="6d67f-291">The [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="6d67f-292">Uygulama için RBAC rolü atamak için bir örnek isteği:</span><span class="sxs-lookup"><span data-stu-id="6d67f-292">An example request to assign RBAC role to application:</span></span>

    PUT https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/microsoft.authorization/roleassignments/4f87261d-2816-465d-8311-70a27558df4c?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiL*****FlwO1mM7Cw6JWtfY2lGc5
    Content-Type: application/json
    Content-Length: 230

    {"properties": {"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2"}}

<span data-ttu-id="6d67f-293">İstekte aşağıdaki değerler kullanılır:</span><span class="sxs-lookup"><span data-stu-id="6d67f-293">In the request, the following values are used:</span></span>

| <span data-ttu-id="6d67f-294">GUID</span><span class="sxs-lookup"><span data-stu-id="6d67f-294">Guid</span></span> | <span data-ttu-id="6d67f-295">Açıklama</span><span class="sxs-lookup"><span data-stu-id="6d67f-295">Description</span></span> |
| --- | --- |
| <span data-ttu-id="6d67f-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span><span class="sxs-lookup"><span data-stu-id="6d67f-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span></span> |<span data-ttu-id="6d67f-297">Abonelik kimliği</span><span class="sxs-lookup"><span data-stu-id="6d67f-297">the id of the subscription</span></span> |
| <span data-ttu-id="6d67f-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span><span class="sxs-lookup"><span data-stu-id="6d67f-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span></span> |<span data-ttu-id="6d67f-299">uygulamanın hizmet asıl nesne kimliği</span><span class="sxs-lookup"><span data-stu-id="6d67f-299">the object id of the service principal of the application</span></span> |
| <span data-ttu-id="6d67f-300">acdd72a7-3385-48EF-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="6d67f-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |<span data-ttu-id="6d67f-301">Okuyucu rolü kimliği</span><span class="sxs-lookup"><span data-stu-id="6d67f-301">the id of the reader role</span></span> |
| <span data-ttu-id="6d67f-302">4f87261d-2816-465D-8311-70a27558df4c</span><span class="sxs-lookup"><span data-stu-id="6d67f-302">4f87261d-2816-465d-8311-70a27558df4c</span></span> |<span data-ttu-id="6d67f-303">Yeni rol ataması için oluşturulan yeni bir GUID</span><span class="sxs-lookup"><span data-stu-id="6d67f-303">a new guid created for the new role assignment</span></span> |

<span data-ttu-id="6d67f-304">Yanıt şu biçimdedir:</span><span class="sxs-lookup"><span data-stu-id="6d67f-304">The response is in the following format:</span></span>

    HTTP/1.1 201 Created

    {"properties":{"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2","scope":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb"},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleAssignments/4f87261d-2816-465d-8311-70a27558df4c","type":"Microsoft.Authorization/roleAssignments","name":"4f87261d-2816-465d-8311-70a27558df4c"}

### <a name="get-app-only-access-token-for-azure-resource-manager"></a><span data-ttu-id="6d67f-305">Azure kaynak yöneticisi için yalnızca uygulama erişim belirteci alma</span><span class="sxs-lookup"><span data-stu-id="6d67f-305">Get app-only access token for Azure Resource Manager</span></span>
<span data-ttu-id="6d67f-306">Bu uygulama doğrulamak için Abonelik üzerinde erişim, yalnızca uygulama belirteci kullanarak abonelikte test görevi gerçekleştirmek istediğiniz sahiptir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-306">To validate that app has the desired access on the subscription, perform a test task on the subscription using an app-only token.</span></span>

<span data-ttu-id="6d67f-307">Yalnızca uygulama erişim belirteci almak için bölümündeki yönergeleri izleyin [almak yalnızca uygulama erişim belirteci için Azure AD Graph API](#app-azure-ad-graph), kaynak parametresi için farklı bir değerle:</span><span class="sxs-lookup"><span data-stu-id="6d67f-307">To get an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for the resource parameter:</span></span>

    https://management.core.windows.net/

<span data-ttu-id="6d67f-308">[ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) yöntemi ASP.NET MVC örnek uygulamasının alır yalnızca uygulama erişim belirteci Azure Resource Manager için Active Directory kimlik doğrulama kitaplığı .net için kullanma.</span><span class="sxs-lookup"><span data-stu-id="6d67f-308">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using the Active Directory Authentication Library for .net.</span></span>

#### <a name="get-applications-permissions-on-subscription"></a><span data-ttu-id="6d67f-309">Uygulama izinleri abonelikte Al</span><span class="sxs-lookup"><span data-stu-id="6d67f-309">Get Application's Permissions on Subscription</span></span>
<span data-ttu-id="6d67f-310">Uygulamanız bir Azure aboneliğine yönelik istenen erişime sahip olduğunu denetlemek için aynı zamanda çağırabilir [kaynak yöneticisi izinleri](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span><span class="sxs-lookup"><span data-stu-id="6d67f-310">To check that your application has the desired access on an Azure subscription, you may also call the [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span></span> <span data-ttu-id="6d67f-311">Bu yaklaşım, kullanıcının abonelik için erişim yönetim haklarına sahip olup olmadığını belirleme için benzer.</span><span class="sxs-lookup"><span data-stu-id="6d67f-311">This approach is similar to how you determined whether the user has Access Management rights for the subscription.</span></span> <span data-ttu-id="6d67f-312">Ancak, bu süre, önceki adımda aldığınız yalnızca uygulama erişim belirtecini izinlerle API çağrısı.</span><span class="sxs-lookup"><span data-stu-id="6d67f-312">However, this time, call the permissions API with the app-only access token that you received in the previous step.</span></span>

<span data-ttu-id="6d67f-313">[ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) yöntemi ASP.NET MVC örnek uygulaması, bu çağrıyı uygular.</span><span class="sxs-lookup"><span data-stu-id="6d67f-313">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample app implements this call.</span></span>

## <a name="manage-connected-subscriptions"></a><span data-ttu-id="6d67f-314">Bağlı aboneliklerini yönetme</span><span class="sxs-lookup"><span data-stu-id="6d67f-314">Manage connected subscriptions</span></span>
<span data-ttu-id="6d67f-315">Uygulamanızın hizmet üzerinde bir abonelik sorumlusu için uygun RBAC rolü atandığında, uygulamanızı izleme/Azure kaynak yöneticisi için yalnızca uygulama erişim belirteçleri kullanarak yönetme tutun.</span><span class="sxs-lookup"><span data-stu-id="6d67f-315">When the appropriate RBAC role is assigned to your application's service principal on the subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span></span>

<span data-ttu-id="6d67f-316">Abonelik sahibi Klasik Portalı'nı veya komut satırı araçlarını kullanarak, uygulamanızın rol ataması kaldırırsa, uygulamanız bu abonelik erişebilir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-316">If a subscription owner removes your application's role assignment using the classic portal or command-line tools, your application is no longer able to access that subscription.</span></span> <span data-ttu-id="6d67f-317">Bu durumda, abonelik ile bağlantı uygulaması dışında koptu kullanıcıya bildir ve "Bağlantıyı Onar" seçeneğini verin.</span><span class="sxs-lookup"><span data-stu-id="6d67f-317">In that case, you should notify the user that the connection with the subscription was severed from outside the application and give them an option to "repair" the connection.</span></span> <span data-ttu-id="6d67f-318">"Onar" yalnızca çevrimdışı silindi rol ataması yeniden oluşturur.</span><span class="sxs-lookup"><span data-stu-id="6d67f-318">"Repair" would simply re-create the role assignment that was deleted offline.</span></span>

<span data-ttu-id="6d67f-319">Abonelikler, uygulamaya bağlanmak kullanıcı yalnızca etkin olarak abonelikleri çok bağlantısını kesmek kullanıcı izin vermesi gerekir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-319">Just as you enabled the user to connect subscriptions to your application, you must allow the user to disconnect subscriptions too.</span></span> <span data-ttu-id="6d67f-320">Bir erişim yönetimi açısından bakıldığında, uygulamanın hizmet sorumlusu abonelikte sahip rol atamasının kaldırılması anlamına gelir bağlantısını kesin.</span><span class="sxs-lookup"><span data-stu-id="6d67f-320">From an access management point of view, disconnect means removing the role assignment that the application's service principal has on the subscription.</span></span> <span data-ttu-id="6d67f-321">İsteğe bağlı olarak, abonelik için uygulamada herhangi bir durum çok kaldırılmış olabilir.</span><span class="sxs-lookup"><span data-stu-id="6d67f-321">Optionally, any state in the application for the subscription might be removed too.</span></span>
<span data-ttu-id="6d67f-322">Yalnızca abonelik erişim yönetim izni olan kullanıcılar abonelik bağlantısını kesmek kullanabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="6d67f-322">Only users with access management permission on the subscription are able to disconnect the subscription.</span></span>

<span data-ttu-id="6d67f-323">[RevokeRoleFromServicePrincipalOnSubscription yöntemi](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) ASP.net MVC örnek uygulama bu çağrıyı uygular.</span><span class="sxs-lookup"><span data-stu-id="6d67f-323">The [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="6d67f-324">İşte bu kadar - kullanıcılar artık kolayca bağlanabilir ve uygulamanız ile bunların Azure Aboneliklerini yönetmek.</span><span class="sxs-lookup"><span data-stu-id="6d67f-324">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span></span>
