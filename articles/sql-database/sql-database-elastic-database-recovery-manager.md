---
title: "aaaUsing kurtarma Yöneticisi toofix parça eşleme sorunları | Microsoft Docs"
description: "Merhaba RecoveryManager sınıfı toosolve parça eşlemeleri sorun kullanın"
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: 2218fb15122f1df466e65483480461e366317f2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 10/06/2017
---
# <a name="using-hello-recoverymanager-class-toofix-shard-map-problems"></a><span data-ttu-id="125bb-103">Merhaba RecoveryManager sınıfı toofix parça eşlemesi sorunlarının kullanma</span><span class="sxs-lookup"><span data-stu-id="125bb-103">Using hello RecoveryManager class toofix shard map problems</span></span>
<span data-ttu-id="125bb-104">Merhaba [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) sınıfı hello özelliği tooeasily algılayıp hello genel parça eşleme (GSM) parçalı veritabanı ortamında hello yerel parça eşleme (LSM) arasındaki tutarsızlıkları düzeltmek ADO.Net uygulamaları sağlar.</span><span class="sxs-lookup"><span data-stu-id="125bb-104">hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications hello ability tooeasily detect and correct any inconsistencies between hello global shard map (GSM) and hello local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="125bb-105">Merhaba GSM ve LSM izleme hello eşleme parçalı bir ortamda her veritabanı.</span><span class="sxs-lookup"><span data-stu-id="125bb-105">hello GSM and LSM track hello mapping of each database in a sharded environment.</span></span> <span data-ttu-id="125bb-106">Bazen, bir kesme hello GSM ve hello LSM arasında oluşur.</span><span class="sxs-lookup"><span data-stu-id="125bb-106">Occasionally, a break occurs between hello GSM and hello LSM.</span></span> <span data-ttu-id="125bb-107">Bu durumda, hello RecoveryManager sınıfı toodetect kullanın ve hello sonu onarın.</span><span class="sxs-lookup"><span data-stu-id="125bb-107">In that case, use hello RecoveryManager class toodetect and repair hello break.</span></span>

<span data-ttu-id="125bb-108">Merhaba RecoveryManager sınıfı hello bir parçasıdır [esnek veritabanı istemci Kitaplığı](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="125bb-108">hello RecoveryManager class is part of hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Parça eşleme][1]

<span data-ttu-id="125bb-110">Terim tanımları için bkz: [esnek veritabanı araçlarını sözlüğü](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="125bb-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="125bb-111">toounderstand nasıl hello **ShardMapManager** kullanılan toomanage veri parçalı bir çözümde bkz [parça eşleme Yönetim](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="125bb-111">toounderstand how hello **ShardMapManager** is used toomanage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-hello-recovery-manager"></a><span data-ttu-id="125bb-112">Merhaba kurtarma Yöneticisi neden kullanılır?</span><span class="sxs-lookup"><span data-stu-id="125bb-112">Why use hello recovery manager?</span></span>
<span data-ttu-id="125bb-113">Parçalı veritabanı ortamında, bir kiracı veritabanı başına ve sunucu başına birçok veritabanı yok.</span><span class="sxs-lookup"><span data-stu-id="125bb-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="125bb-114">Ayrıca olabilir pek çok sunucu hello ortamında.</span><span class="sxs-lookup"><span data-stu-id="125bb-114">There can also be many servers in hello environment.</span></span> <span data-ttu-id="125bb-115">Böylece çağrıları yönlendirilmiş toohello doğru sunucu ve veritabanı her veritabanı hello parça eşlemesinde eşlenir.</span><span class="sxs-lookup"><span data-stu-id="125bb-115">Each database is mapped in hello shard map, so calls can be routed toohello correct server and database.</span></span> <span data-ttu-id="125bb-116">Veritabanlarını tooa göre izlenen **parçalama anahtar**, ve her parça atanan bir **anahtar değerlerin**.</span><span class="sxs-lookup"><span data-stu-id="125bb-116">Databases are tracked according tooa **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="125bb-117">Örneğin, bir parçalama anahtar hello müşteri adları "D" "F'ye" çok temsil edebilir</span><span class="sxs-lookup"><span data-stu-id="125bb-117">For example, a sharding key may represent hello customer names from "D" too"F."</span></span> <span data-ttu-id="125bb-118">tüm parça (diğer adıyla veritabanları) eşleme hello ve bunların eşleme aralıkları hello içerdiği **genel parça eşleme (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="125bb-118">hello mapping of all shards (aka databases) and their mapping ranges are contained in hello **global shard map (GSM)**.</span></span> <span data-ttu-id="125bb-119">Her veritabanı hello adlandırılıyor hello parça üzerinde yer alan hello aralıkları haritasını de içeren **yerel parça eşleme (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="125bb-119">Each database also contains a map of hello ranges contained on hello shard that is known as hello **local shard map (LSM)**.</span></span> <span data-ttu-id="125bb-120">Bir uygulama tooa parça bağlandığında, hello eşleme hello app hızlı alma için önbelleğe alınır.</span><span class="sxs-lookup"><span data-stu-id="125bb-120">When an app connects tooa shard, hello mapping is cached with hello app for quick retrieval.</span></span> <span data-ttu-id="125bb-121">Merhaba LSM önbelleğe kullanılan toovalidate verilerdir.</span><span class="sxs-lookup"><span data-stu-id="125bb-121">hello LSM is used toovalidate cached data.</span></span> 

<span data-ttu-id="125bb-122">Merhaba GSM ve LSM nedenleri aşağıdaki Merhaba eşitlenmemiş hale gelebilir:</span><span class="sxs-lookup"><span data-stu-id="125bb-122">hello GSM and LSM may become out of sync for hello following reasons:</span></span>

1. <span data-ttu-id="125bb-123">Merhaba, aralığı toono uzun düşünülen bir parça silinmesini kullanın veya parça yeniden adlandırma.</span><span class="sxs-lookup"><span data-stu-id="125bb-123">hello deletion of a shard whose range is believed toono longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="125bb-124">Bir parça silme sonuçlanıyor bir **parça eşleme yalnız**.</span><span class="sxs-lookup"><span data-stu-id="125bb-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="125bb-125">Benzer şekilde, yeniden adlandırılmış bir veritabanını yalnız bırakılmış parça eşleme neden olabilir.</span><span class="sxs-lookup"><span data-stu-id="125bb-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="125bb-126">Merhaba değişikliğin hello amacı, bağlı olarak hello parça kaldırılan toobe gerekebilir veya güncelleştirilmiş toobe hello parça konum gerekiyor.</span><span class="sxs-lookup"><span data-stu-id="125bb-126">Depending on hello intent of hello change, hello shard may need toobe removed or hello shard location needs toobe updated.</span></span> <span data-ttu-id="125bb-127">Silinen bir veritabanını toorecover bkz [silinen bir veritabanını geri](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="125bb-127">toorecover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="125bb-128">Bir yük devretme coğrafi olayı oluşur.</span><span class="sxs-lookup"><span data-stu-id="125bb-128">A geo-failover event occurs.</span></span> <span data-ttu-id="125bb-129">toocontinue, bir hello sunucu adını ve veritabanı adını parça eşleme Yöneticisi'nde hello uygulama ve güncelleştirme hello parça eşleme ayrıntılarını tüm parça parça eşlemesindeki güncelleştirmeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="125bb-129">toocontinue, one must update hello server name, and database name of shard map manager in hello application and then update hello shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="125bb-130">Bir yük devretme coğrafi ise, böyle bir kurtarma mantık hello yük devretme iş akışı içinde otomatik olarak.</span><span class="sxs-lookup"><span data-stu-id="125bb-130">If there is a geo-failover, such recovery logic should be automated within hello failover workflow.</span></span> <span data-ttu-id="125bb-131">Kurtarma eylemleri otomatikleştirme coğrafi etkinleştirilmiş veritabanları için uyumlu bir yönetilebilirlik sağlar ve el ile İnsan Eylemler önler.</span><span class="sxs-lookup"><span data-stu-id="125bb-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="125bb-132">bir veri merkezi kesintisinden ise bir veritabanı bakın seçenekleri toorecover hakkında toolearn [iş sürekliliği](sql-database-business-continuity.md) ve [olağanüstü durum kurtarma](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="125bb-132">toolearn about options toorecover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="125bb-133">Bir parça veya hello ShardMapManager geri yüklenen tooan veritabanıdır önceki noktası süre.</span><span class="sxs-lookup"><span data-stu-id="125bb-133">Either a shard or hello ShardMapManager database is restored tooan earlier point-in time.</span></span> <span data-ttu-id="125bb-134">toolearn yedeklemeler kullanarak zaman kurtarma noktası hakkında bkz [Yedekleme kullanarak kurtarma](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="125bb-134">toolearn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="125bb-135">Azure SQL veritabanı esnek veritabanı araçlarını, coğrafi çoğaltma ve geri yükleme hakkında daha fazla bilgi için hello aşağıdakilere bakın:</span><span class="sxs-lookup"><span data-stu-id="125bb-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see hello following:</span></span> 

* [<span data-ttu-id="125bb-136">Genel Bakış: SQL veritabanı ile iş devamlılığı ve veritabanı olağanüstü durum kurtarma bulut</span><span class="sxs-lookup"><span data-stu-id="125bb-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="125bb-137">Esnek veritabanı araçlarını kullanmaya başlama</span><span class="sxs-lookup"><span data-stu-id="125bb-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="125bb-138">ShardMap Yönetimi</span><span class="sxs-lookup"><span data-stu-id="125bb-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="125bb-139">Bir ShardMapManager RecoveryManager alınıyor</span><span class="sxs-lookup"><span data-stu-id="125bb-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="125bb-140">Merhaba ilk adımı toocreate RecoveryManager örneği oluşturur.</span><span class="sxs-lookup"><span data-stu-id="125bb-140">hello first step is toocreate a RecoveryManager instance.</span></span> <span data-ttu-id="125bb-141">Merhaba [GetRecoveryManager yöntemi](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) döndürür hello hello geçerli kurtarma Yöneticisi [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) örneği.</span><span class="sxs-lookup"><span data-stu-id="125bb-141">hello [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns hello recovery manager for hello current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="125bb-142">Merhaba parça bulunan tüm tutarsızlıkları tooaddress eşleme, hello RecoveryManager hello belirli parça eşleme için ilk almanız gerekir.</span><span class="sxs-lookup"><span data-stu-id="125bb-142">tooaddress any inconsistencies in hello shard map, you must first retrieve hello RecoveryManager for hello particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="125bb-143">Bu örnekte, hello RecoveryManager hello ShardMapManager ' başlatılır.</span><span class="sxs-lookup"><span data-stu-id="125bb-143">In this example, hello RecoveryManager is initialized from hello ShardMapManager.</span></span> <span data-ttu-id="125bb-144">Merhaba bir ShardMap içeren ShardMapManager de zaten başlatılmış.</span><span class="sxs-lookup"><span data-stu-id="125bb-144">hello ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="125bb-145">Bu uygulama kodu hello parça eşleme kendisini yöneten beri hello Fabrika yönteminde kullanılan kimlik bilgileri hello (örneğin, önceki hello içinde smmConnectionString) hello tarafından başvurulan hello GSM veritabanı üzerinde okuma-yazma izinlerine sahip kimlik bilgileri olmalıdır bağlantı dizesi.</span><span class="sxs-lookup"><span data-stu-id="125bb-145">Since this application code manipulates hello shard map itself, hello credentials used in hello factory method (in hello preceding example, smmConnectionString) should be credentials that have read-write permissions on hello GSM database referenced by hello connection string.</span></span> <span data-ttu-id="125bb-146">Bu kimlik bilgileri, veri bağımlı yönlendirme için kullanılan kimlik bilgileri tooopen bağlantılar genellikle farklıdır.</span><span class="sxs-lookup"><span data-stu-id="125bb-146">These credentials are typically different from credentials used tooopen connections for data-dependent routing.</span></span> <span data-ttu-id="125bb-147">Daha fazla bilgi için bkz: [hello esnek veritabanı istemci kimlik bilgilerini kullanarak](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="125bb-147">For more information, see [Using credentials in hello elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-hello-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="125bb-148">Bir parça silindikten sonra bir parça hello ShardMap ' kaldırma</span><span class="sxs-lookup"><span data-stu-id="125bb-148">Removing a shard from hello ShardMap after a shard is deleted</span></span>
<span data-ttu-id="125bb-149">Merhaba [DetachShard yöntemi](https://msdn.microsoft.com/library/azure/dn842083.aspx) parça hello parça eşlemesinden verilen hello ayırır ve hello parça ile ilişkili eşlemeleri siler.</span><span class="sxs-lookup"><span data-stu-id="125bb-149">hello [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches hello given shard from hello shard map and deletes mappings associated with hello shard.</span></span>  

* <span data-ttu-id="125bb-150">Merhaba konum parametresi hello parça, özellikle sunucu adını ve veritabanı adını ayrılmakta hello parça konumdur.</span><span class="sxs-lookup"><span data-stu-id="125bb-150">hello location parameter is hello shard location, specifically server name and database name, of hello shard being detached.</span></span> 
* <span data-ttu-id="125bb-151">Merhaba shardMapName parametresi hello parça eşleme adıdır.</span><span class="sxs-lookup"><span data-stu-id="125bb-151">hello shardMapName parameter is hello shard map name.</span></span> <span data-ttu-id="125bb-152">Bu yalnızca olan birden fazla parça eşlemeleri hello tarafından yönetildiğinde gerekli aynı parça eşleme Yöneticisi.</span><span class="sxs-lookup"><span data-stu-id="125bb-152">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="125bb-153">İsteğe bağlı.</span><span class="sxs-lookup"><span data-stu-id="125bb-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="125bb-154">Yalnızca hello aralığı güncelleştirilmiş hello eşlemesi için boş olduğundan eminseniz bu tekniği kullanın.</span><span class="sxs-lookup"><span data-stu-id="125bb-154">Use this technique only if you are certain that hello range for hello updated mapping is empty.</span></span> <span data-ttu-id="125bb-155">Yukarıdaki Hello yöntemleri taşınan hello aralığı için veri denetleme, en iyi şekilde kodunuzda tooinclude denetler.</span><span class="sxs-lookup"><span data-stu-id="125bb-155">hello methods above do not check data for hello range being moved, so it is best tooinclude checks in your code.</span></span>
>

<span data-ttu-id="125bb-156">Bu örnek parça hello parça eşlemesinden kaldırır.</span><span class="sxs-lookup"><span data-stu-id="125bb-156">This example removes shards from hello shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="125bb-157">Merhaba parça eşleme hello parça hello GSM hello parça hello silinmesini önce konumda yansıtır.</span><span class="sxs-lookup"><span data-stu-id="125bb-157">hello shard map reflects hello shard location in hello GSM before hello deletion of hello shard.</span></span> <span data-ttu-id="125bb-158">Merhaba parça silindiği için bu kasıtlı ve hello parçalama anahtar aralığı artık kullanımda varsayılır.</span><span class="sxs-lookup"><span data-stu-id="125bb-158">Because hello shard was deleted, it is assumed this was intentional, and hello sharding key range is no longer in use.</span></span> <span data-ttu-id="125bb-159">Aksi durumda, zaman içinde nokta geri yükleme yürütebilir.</span><span class="sxs-lookup"><span data-stu-id="125bb-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="125bb-160">bir önceki noktası zaman gelen toorecover hello parça.</span><span class="sxs-lookup"><span data-stu-id="125bb-160">toorecover hello shard from an earlier point-in-time.</span></span> <span data-ttu-id="125bb-161">(Bu durumda, aşağıdaki bölümde toodetect parça tutarsızlıklar hello gözden geçirin.) toorecover, bkz: [zaman kurtarma noktası](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="125bb-161">(In that case, review hello following section toodetect shard inconsistencies.) toorecover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="125bb-162">Merhaba veritabanı silme kasıtlı varsayıldığından hello son yönetim temizleme toodelete hello girişi toohello parça hello parça eşleme Yöneticisi'nde bir eylemdir.</span><span class="sxs-lookup"><span data-stu-id="125bb-162">Since it is assumed hello database deletion was intentional, hello final administrative cleanup action is toodelete hello entry toohello shard in hello shard map manager.</span></span> <span data-ttu-id="125bb-163">Bu, istemeden beklenmiyor bilgiler tooa aralığı yazmasını Merhaba uygulaması engeller.</span><span class="sxs-lookup"><span data-stu-id="125bb-163">This prevents hello application from inadvertently writing information tooa range that is not expected.</span></span>

## <a name="toodetect-mapping-differences"></a><span data-ttu-id="125bb-164">toodetect eşleme farklar</span><span class="sxs-lookup"><span data-stu-id="125bb-164">toodetect mapping differences</span></span>
<span data-ttu-id="125bb-165">Merhaba [DetectMappingDifferences yöntemi](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) seçer ve her iki parça eşlemeleri (GSM ve LSM) eşlemesi uzlaştırır hello parça eşlemeleri (yerel veya genel) gerçekte hello kaynağı olarak döndürür.</span><span class="sxs-lookup"><span data-stu-id="125bb-165">hello [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="125bb-166">Merhaba *konumu* hello sunucu adını ve veritabanı adını belirtir.</span><span class="sxs-lookup"><span data-stu-id="125bb-166">hello *location* specifies hello server name and database name.</span></span> 
* <span data-ttu-id="125bb-167">Merhaba *shardMapName* parametredir hello parça eşleme adı.</span><span class="sxs-lookup"><span data-stu-id="125bb-167">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="125bb-168">Yalnızca budur birden fazla parça eşlemeleri hello tarafından yönetilen, gerekli aynı parça eşleme Yöneticisi.</span><span class="sxs-lookup"><span data-stu-id="125bb-168">This is only required if multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="125bb-169">İsteğe bağlı.</span><span class="sxs-lookup"><span data-stu-id="125bb-169">Optional.</span></span> 

## <a name="tooresolve-mapping-differences"></a><span data-ttu-id="125bb-170">tooresolve eşleme farklar</span><span class="sxs-lookup"><span data-stu-id="125bb-170">tooresolve mapping differences</span></span>
<span data-ttu-id="125bb-171">Merhaba [ResolveMappingDifferences yöntemi](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) hello parça eşlemeleri (yerel veya genel) birini gerçekte hello kaynağı olarak seçer ve her iki parça eşlemeleri (GSM ve LSM) eşlemesi uzlaştırır.</span><span class="sxs-lookup"><span data-stu-id="125bb-171">hello [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="125bb-172">Merhaba *RecoveryToken* parametresi hello eşlemeleri hello farklılıkları hello GSM hello belirli parça Merhaba LSM arasındaki numaralandırır.</span><span class="sxs-lookup"><span data-stu-id="125bb-172">hello *RecoveryToken* parameter enumerates hello differences in hello mappings between hello GSM and hello LSM for hello specific shard.</span></span> 
* <span data-ttu-id="125bb-173">Merhaba [MappingDifferenceResolution numaralandırma](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) hello parça eşlemeleri hello birbirinden çözmek için kullanılan tooindicate hello yöntemidir.</span><span class="sxs-lookup"><span data-stu-id="125bb-173">hello [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used tooindicate hello method for resolving hello difference between hello shard mappings.</span></span> 
* <span data-ttu-id="125bb-174">**MappingDifferenceResolution.KeepShardMapping** hello LSM içerdiğinde hello doğru eşleme ve bu nedenle hello parça hello eşlemesindeki kullanılmalıdır önerilir.</span><span class="sxs-lookup"><span data-stu-id="125bb-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when hello LSM contains hello accurate mapping and therefore hello mapping in hello shard should be used.</span></span> <span data-ttu-id="125bb-175">Bir yük devretme ise genellikle hello böyledir: hello parça şimdi yeni bir sunucuda yer alıyor.</span><span class="sxs-lookup"><span data-stu-id="125bb-175">This is typically hello case if there is a failover: hello shard now resides on a new server.</span></span> <span data-ttu-id="125bb-176">Merhaba parça (Merhaba RecoveryManager.DetachShard yöntemi kullanılarak) GSM hello kaldırılmalıdır olduğundan, bir eşleme GSM hello üzerinde artık yok.</span><span class="sxs-lookup"><span data-stu-id="125bb-176">Since hello shard must first be removed from hello GSM (using hello RecoveryManager.DetachShard method), a mapping no longer exists on hello GSM.</span></span> <span data-ttu-id="125bb-177">Bu nedenle, hello LSM kullanılan toore olmalıdır-hello parça eşleme oluşturun.</span><span class="sxs-lookup"><span data-stu-id="125bb-177">Therefore, hello LSM must be used toore-establish hello shard mapping.</span></span>

## <a name="attach-a-shard-toohello-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="125bb-178">Bir parça geri yüklendikten sonra parça toohello ShardMap ekleme</span><span class="sxs-lookup"><span data-stu-id="125bb-178">Attach a shard toohello ShardMap after a shard is restored</span></span>
<span data-ttu-id="125bb-179">Merhaba [AttachShard yöntemi](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) ekler hello verilen parça toohello parça eşleme.</span><span class="sxs-lookup"><span data-stu-id="125bb-179">hello [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches hello given shard toohello shard map.</span></span> <span data-ttu-id="125bb-180">Parça eşleme tutarsızlıkları algılar ve hello eşlemeleri toomatch hello parça hello parça geri yükleme işlemi hello noktada güncelleştirir.</span><span class="sxs-lookup"><span data-stu-id="125bb-180">It then detects any shard map inconsistencies and updates hello mappings toomatch hello shard at hello point of hello shard restoration.</span></span> <span data-ttu-id="125bb-181">Merhaba zaman içinde nokta geri yüklemesi hello damgasıyla eklenmiş tooa yeni veritabanı varsayılan olarak bu yana hello veritabanının da (Merhaba parça geri önce) yeniden adlandırılmış tooreflect hello özgün veritabanı adıdır varsayılır.</span><span class="sxs-lookup"><span data-stu-id="125bb-181">It is assumed that hello database is also renamed tooreflect hello original database name (before hello shard was restored), since hello point-in time restoration defaults tooa new database appended with hello timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="125bb-182">Merhaba *konumu* parametredir hello sunucu adını ve veritabanı adını iliştirilmekte hello parça.</span><span class="sxs-lookup"><span data-stu-id="125bb-182">hello *location* parameter is hello server name and database name, of hello shard being attached.</span></span> 
* <span data-ttu-id="125bb-183">Merhaba *shardMapName* parametredir hello parça eşleme adı.</span><span class="sxs-lookup"><span data-stu-id="125bb-183">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="125bb-184">Bu yalnızca olan birden fazla parça eşlemeleri hello tarafından yönetildiğinde gerekli aynı parça eşleme Yöneticisi.</span><span class="sxs-lookup"><span data-stu-id="125bb-184">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="125bb-185">İsteğe bağlı.</span><span class="sxs-lookup"><span data-stu-id="125bb-185">Optional.</span></span> 

<span data-ttu-id="125bb-186">Bu örnek, önceki noktası-zaman bir yakın zamanda geri bir parça toohello parça eşlemesi ekler.</span><span class="sxs-lookup"><span data-stu-id="125bb-186">This example adds a shard toohello shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="125bb-187">Merhaba parça (yani hello hello LSM içinde hello parça eşleme) geri olduğundan, büyük olasılıkla tutarsız hello parça hello GSM girişi ile kalır.</span><span class="sxs-lookup"><span data-stu-id="125bb-187">Since hello shard (namely hello mapping for hello shard in hello LSM) has been restored, it is potentially inconsistent with hello shard entry in hello GSM.</span></span> <span data-ttu-id="125bb-188">Bu örnek kod dışında hello parça geri yüklendi ve hello veritabanının toohello orijinal adı yeniden adlandırıldı.</span><span class="sxs-lookup"><span data-stu-id="125bb-188">Outside of this example code, hello shard was restored and renamed toohello original name of hello database.</span></span> <span data-ttu-id="125bb-189">Geri yüklenen beri hello güvenilen eşleme hello eşleme hello LSM içinde olduğu varsayılır.</span><span class="sxs-lookup"><span data-stu-id="125bb-189">Since it was restored, it is assumed hello mapping in hello LSM is hello trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-hello-shards"></a><span data-ttu-id="125bb-190">Bir coğrafi-yük devretme (geri yükleme) hello parça parça konumları güncelleştiriliyor</span><span class="sxs-lookup"><span data-stu-id="125bb-190">Updating shard locations after a geo-failover (restore) of hello shards</span></span>
<span data-ttu-id="125bb-191">Bir yük devretme coğrafi ise hello ikincil veritabanı yazma erişilebilir yapılır ve hello yeni birincil veritabanı haline gelir.</span><span class="sxs-lookup"><span data-stu-id="125bb-191">If there is a geo-failover, hello secondary database is made write accessible and becomes hello new primary database.</span></span> <span data-ttu-id="125bb-192">Merhaba sunucu ve potansiyel olarak (bağlı olarak yapılandırmanızı) hello veritabanı adı Merhaba, hello özgün birincil sunucudan farklı olabilir.</span><span class="sxs-lookup"><span data-stu-id="125bb-192">hello name of hello server, and potentially hello database (depending on your configuration), may be different from hello original primary.</span></span> <span data-ttu-id="125bb-193">Bu nedenle hello GSM içinde hello parça eşleme girdileri hello ve LSM düzeltilmesi gerekir.</span><span class="sxs-lookup"><span data-stu-id="125bb-193">Therefore hello mapping entries for hello shard in hello GSM and LSM must be fixed.</span></span> <span data-ttu-id="125bb-194">Benzer şekilde, hello veritabanının geri yüklenen tooa farklı bir ad veya konum veya tooan ise daha önceki bir noktaya, bu neden olabilecek tutarsızlıklar hello parça eşlemeleri.</span><span class="sxs-lookup"><span data-stu-id="125bb-194">Similarly, if hello database is restored tooa different name or location, or tooan earlier point in time, this might cause inconsistencies in hello shard maps.</span></span> <span data-ttu-id="125bb-195">Merhaba parça eşleme Yöneticisi açık bağlantıları toohello doğru veritabanı hello dağıtımını işler.</span><span class="sxs-lookup"><span data-stu-id="125bb-195">hello Shard Map Manager handles hello distribution of open connections toohello correct database.</span></span> <span data-ttu-id="125bb-196">Dağıtım hello parça eşleme ve hello hello uygulamaları isteği hello hedefidir hello parçalama anahtarının değerini hello verileri temel alır.</span><span class="sxs-lookup"><span data-stu-id="125bb-196">Distribution is based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello applications request.</span></span> <span data-ttu-id="125bb-197">Coğrafi-yük devretme sonrasında, bu bilgileri hello doğru sunucu adını, veritabanı adının ve hello kurtarılan veritabanının parça eşleme ile güncelleştirilmesi gerekir.</span><span class="sxs-lookup"><span data-stu-id="125bb-197">After a geo-failover, this information must be updated with hello accurate server name, database name and shard mapping of hello recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="125bb-198">En iyi uygulamalar</span><span class="sxs-lookup"><span data-stu-id="125bb-198">Best practices</span></span>
<span data-ttu-id="125bb-199">Coğrafi yük devretme ve kurtarma genellikle Merhaba uygulaması özellikle Azure SQL veritabanları iş sürekliliği özelliklerden biri kullanılarak bir bulut Yöneticisi tarafından yönetilen işlemleridir.</span><span class="sxs-lookup"><span data-stu-id="125bb-199">Geo-failover and recovery are operations typically managed by a cloud administrator of hello application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="125bb-200">İş sürekliliği planlama işlemleri, yordamlar ve işletme işlemleri kesintisiz devam edebilirsiniz ölçüleri tooensure gerektirir.</span><span class="sxs-lookup"><span data-stu-id="125bb-200">Business continuity planning requires processes, procedures, and measures tooensure that business operations can continue without interruption.</span></span> <span data-ttu-id="125bb-201">Merhaba yöntemleri hello RecoveryManager sınıfı parçası kullanıldığı şekilde kullanılabilir bu iş akışı tooensure hello içinde GSM ve LSM hello kurtarma eyleme geçen bağlı güncel tutulur.</span><span class="sxs-lookup"><span data-stu-id="125bb-201">hello methods available as part of hello RecoveryManager class should be used within this work flow tooensure hello GSM and LSM are kept up-to-date based on hello recovery action taken.</span></span> <span data-ttu-id="125bb-202">Beş temel adımı vardır hello sağlama tooproperly GSM ve LSM hello doğru bilgileri bir yük devretme olayından sonra yansıtır.</span><span class="sxs-lookup"><span data-stu-id="125bb-202">There are five basic steps tooproperly ensuring hello GSM and LSM reflect hello accurate information after a failover event.</span></span> <span data-ttu-id="125bb-203">Bu adımları mevcut araçlar ve iş akışı tümleşik uygulama kodu tooexecute hello.</span><span class="sxs-lookup"><span data-stu-id="125bb-203">hello application code tooexecute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="125bb-204">Merhaba RecoveryManager hello ShardMapManager ' alın.</span><span class="sxs-lookup"><span data-stu-id="125bb-204">Retrieve hello RecoveryManager from hello ShardMapManager.</span></span> 
2. <span data-ttu-id="125bb-205">Merhaba eski parça hello parça eşlemesinden kullanımdan çıkarın.</span><span class="sxs-lookup"><span data-stu-id="125bb-205">Detach hello old shard from hello shard map.</span></span>
3. <span data-ttu-id="125bb-206">Merhaba yeni parça konum dahil olmak üzere hello yeni parça toohello parça eşleme, ekleyin.</span><span class="sxs-lookup"><span data-stu-id="125bb-206">Attach hello new shard toohello shard map, including hello new shard location.</span></span>
4. <span data-ttu-id="125bb-207">Tutarsızlıklar GSM ve LSM hello arasında eşleme hello algıla.</span><span class="sxs-lookup"><span data-stu-id="125bb-207">Detect inconsistencies in hello mapping between hello GSM and LSM.</span></span> 
5. <span data-ttu-id="125bb-208">Merhaba GSM ve hello LSM, güvenen hello LSM arasındaki farklılıkları giderin.</span><span class="sxs-lookup"><span data-stu-id="125bb-208">Resolve differences between hello GSM and hello LSM, trusting hello LSM.</span></span> 

<span data-ttu-id="125bb-209">Bu örnek hello aşağıdaki adımları gerçekleştirir:</span><span class="sxs-lookup"><span data-stu-id="125bb-209">This example performs hello following steps:</span></span>

1. <span data-ttu-id="125bb-210">Parça parça konumlarını hello yük devretme olayından önce gösterecek parça eşleme hello kaldırır.</span><span class="sxs-lookup"><span data-stu-id="125bb-210">Removes shards from hello Shard Map that reflect shard locations before hello failover event.</span></span>
2. <span data-ttu-id="125bb-211">Parça toohello parça eşleme yansıtıcı hello yeni parça konumlar ekler (Merhaba parametresi "Configuration.SecondaryServer" Merhaba yeni bir sunucu adı olan, ancak aynı hello veritabanı adı).</span><span class="sxs-lookup"><span data-stu-id="125bb-211">Attaches shards toohello Shard Map reflecting hello new shard locations (hello parameter "Configuration.SecondaryServer" is hello new server name but hello same database name).</span></span>
3. <span data-ttu-id="125bb-212">Hello GSM ve her parça Merhaba LSM arasındaki eşleme farkları algılayarak Hello kurtarma belirteçlerini alır.</span><span class="sxs-lookup"><span data-stu-id="125bb-212">Retrieves hello recovery tokens by detecting mapping differences between hello GSM and hello LSM for each shard.</span></span> 
4. <span data-ttu-id="125bb-213">Merhaba her parça LSM güvenen hello eşlemesinden tarafından Hello tutarsızlıklar çözümler.</span><span class="sxs-lookup"><span data-stu-id="125bb-213">Resolves hello inconsistencies by trusting hello mapping from hello LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

