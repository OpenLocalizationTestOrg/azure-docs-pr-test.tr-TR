---
title: "Parça eşleme sorunları düzeltmek için kurtarma Yöneticisi'ni kullanarak | Microsoft Docs"
description: "Parça Haritalar ile sorunları çözmek için RecoveryManager sınıfı kullanın"
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: e60e2295484873ea15d52108b7d619319a57827f
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 07/11/2017
---
# <a name="using-the-recoverymanager-class-to-fix-shard-map-problems"></a><span data-ttu-id="24b5b-103">RecoveryManager sınıfı ile parça eşleme sorunlarını düzeltme</span><span class="sxs-lookup"><span data-stu-id="24b5b-103">Using the RecoveryManager class to fix shard map problems</span></span>
<span data-ttu-id="24b5b-104">[RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) sınıfı ADO.Net uygulamaları kolayca algılamak ve genel parça eşleme (GSM) parçalı veritabanı ortamında yerel parça eşleme (LSM) arasındaki tutarsızlıkları düzeltmek olanağı sağlar.</span><span class="sxs-lookup"><span data-stu-id="24b5b-104">The [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications the ability to easily detect and correct any inconsistencies between the global shard map (GSM) and the local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="24b5b-105">GSM ve LSM parçalı bir ortamda her veritabanı eşleme izler.</span><span class="sxs-lookup"><span data-stu-id="24b5b-105">The GSM and LSM track the mapping of each database in a sharded environment.</span></span> <span data-ttu-id="24b5b-106">Bazen, bir kesme GSM ve LSM arasında oluşur.</span><span class="sxs-lookup"><span data-stu-id="24b5b-106">Occasionally, a break occurs between the GSM and the LSM.</span></span> <span data-ttu-id="24b5b-107">Bu durumda, algılamak ve sonu onarmak için RecoveryManager sınıfını kullanın.</span><span class="sxs-lookup"><span data-stu-id="24b5b-107">In that case, use the RecoveryManager class to detect and repair the break.</span></span>

<span data-ttu-id="24b5b-108">RecoveryManager sınıfı parçası olan [esnek veritabanı istemci Kitaplığı](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="24b5b-108">The RecoveryManager class is part of the [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Parça eşleme][1]

<span data-ttu-id="24b5b-110">Terim tanımları için bkz: [esnek veritabanı araçlarını sözlüğü](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="24b5b-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="24b5b-111">Anlamak için nasıl **ShardMapManager** kullanılan veri parçalı bir çözümde yönetmek için bkz: [parça eşleme Yönetim](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="24b5b-111">To understand how the **ShardMapManager** is used to manage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-the-recovery-manager"></a><span data-ttu-id="24b5b-112">Kurtarma Yöneticisi'ni neden kullanılır?</span><span class="sxs-lookup"><span data-stu-id="24b5b-112">Why use the recovery manager?</span></span>
<span data-ttu-id="24b5b-113">Parçalı veritabanı ortamında, bir kiracı veritabanı başına ve sunucu başına birçok veritabanı yok.</span><span class="sxs-lookup"><span data-stu-id="24b5b-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="24b5b-114">Ayrıca olabilir pek çok sunucu ortamında.</span><span class="sxs-lookup"><span data-stu-id="24b5b-114">There can also be many servers in the environment.</span></span> <span data-ttu-id="24b5b-115">Çağrılar doğru sunucu ve veritabanı yönlendirilebilir şekilde her veritabanı parça eşlemesinde eşlenir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-115">Each database is mapped in the shard map, so calls can be routed to the correct server and database.</span></span> <span data-ttu-id="24b5b-116">Veritabanları göre izlenen bir **parçalama anahtar**, ve her parça atanan bir **anahtar değerlerin**.</span><span class="sxs-lookup"><span data-stu-id="24b5b-116">Databases are tracked according to a **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="24b5b-117">Örneğin, bir parçalama anahtar müşteri adları "D" "F" gösterebilir</span><span class="sxs-lookup"><span data-stu-id="24b5b-117">For example, a sharding key may represent the customer names from "D" to "F."</span></span> <span data-ttu-id="24b5b-118">Tüm parça (diğer adıyla veritabanları) ve bunların eşleme aralıkları eşlenmesini içerdiği **genel parça eşleme (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="24b5b-118">The mapping of all shards (aka databases) and their mapping ranges are contained in the **global shard map (GSM)**.</span></span> <span data-ttu-id="24b5b-119">Her veritabanı olarak bilinen parça üzerinde yer alan aralıkları haritasını de içeren **yerel parça eşleme (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="24b5b-119">Each database also contains a map of the ranges contained on the shard that is known as the **local shard map (LSM)**.</span></span> <span data-ttu-id="24b5b-120">Bir uygulama için bir parça bağlandığında, eşleme uygulama hızlı alma için önbelleğe alınır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-120">When an app connects to a shard, the mapping is cached with the app for quick retrieval.</span></span> <span data-ttu-id="24b5b-121">LSM önbelleğe alınmış verileri doğrulamak için kullanılır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-121">The LSM is used to validate cached data.</span></span> 

<span data-ttu-id="24b5b-122">GSM ve LSM aşağıdaki nedenlerle eşitlenmemiş hale gelebilir:</span><span class="sxs-lookup"><span data-stu-id="24b5b-122">The GSM and LSM may become out of sync for the following reasons:</span></span>

1. <span data-ttu-id="24b5b-123">Bağlantı aralığı artık kullanın veya bir parça yeniden adlandırma düşünülen bir parça silme.</span><span class="sxs-lookup"><span data-stu-id="24b5b-123">The deletion of a shard whose range is believed to no longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="24b5b-124">Bir parça silme sonuçlanıyor bir **parça eşleme yalnız**.</span><span class="sxs-lookup"><span data-stu-id="24b5b-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="24b5b-125">Benzer şekilde, yeniden adlandırılmış bir veritabanını yalnız bırakılmış parça eşleme neden olabilir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="24b5b-126">Değişikliğin amacı, bağlı olarak parça kaldırılması gerekebilir veya parça konumun güncelleştirilmesi gerekiyor.</span><span class="sxs-lookup"><span data-stu-id="24b5b-126">Depending on the intent of the change, the shard may need to be removed or the shard location needs to be updated.</span></span> <span data-ttu-id="24b5b-127">Silinen bir veritabanını kurtarmak için bkz: [silinen bir veritabanını geri](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="24b5b-127">To recover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="24b5b-128">Bir yük devretme coğrafi olayı oluşur.</span><span class="sxs-lookup"><span data-stu-id="24b5b-128">A geo-failover event occurs.</span></span> <span data-ttu-id="24b5b-129">Devam etmek için bir sunucu adını ve veritabanı adını parça eşleme Yöneticisi'nde uygulama güncelleştirin ve sonra bir parça eşlemindeki tüm parça parça eşleme ayrıntılarını güncelleştirin.</span><span class="sxs-lookup"><span data-stu-id="24b5b-129">To continue, one must update the server name, and database name of shard map manager in the application and then update the shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="24b5b-130">Bir yük devretme coğrafi ise, böyle bir kurtarma mantık yük devretme iş akışı içinde otomatik olarak.</span><span class="sxs-lookup"><span data-stu-id="24b5b-130">If there is a geo-failover, such recovery logic should be automated within the failover workflow.</span></span> <span data-ttu-id="24b5b-131">Kurtarma eylemleri otomatikleştirme coğrafi etkinleştirilmiş veritabanları için uyumlu bir yönetilebilirlik sağlar ve el ile İnsan Eylemler önler.</span><span class="sxs-lookup"><span data-stu-id="24b5b-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="24b5b-132">Veri Merkezi kesintisinden ise bir veritabanını kurtarmak için seçenekler hakkında bilgi edinmek için bkz: [iş sürekliliği](sql-database-business-continuity.md) ve [olağanüstü durum kurtarma](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="24b5b-132">To learn about options to recover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="24b5b-133">Bir parça veya ShardMapManager veritabanının bir önceki noktası bileşenini duruma geri yüklenir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-133">Either a shard or the ShardMapManager database is restored to an earlier point-in time.</span></span> <span data-ttu-id="24b5b-134">Yedeklemeler kullanarak zaman kurtarma noktası hakkında bilgi edinmek için [Yedekleme kullanarak kurtarma](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="24b5b-134">To learn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="24b5b-135">Azure SQL veritabanı esnek veritabanı araçlarını, coğrafi çoğaltma ve geri yükleme hakkında daha fazla bilgi için aşağıdakilere bakın:</span><span class="sxs-lookup"><span data-stu-id="24b5b-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see the following:</span></span> 

* [<span data-ttu-id="24b5b-136">Genel Bakış: SQL veritabanı ile iş devamlılığı ve veritabanı olağanüstü durum kurtarma bulut</span><span class="sxs-lookup"><span data-stu-id="24b5b-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="24b5b-137">Esnek veritabanı araçlarını kullanmaya başlama</span><span class="sxs-lookup"><span data-stu-id="24b5b-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="24b5b-138">ShardMap Yönetimi</span><span class="sxs-lookup"><span data-stu-id="24b5b-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="24b5b-139">Bir ShardMapManager RecoveryManager alınıyor</span><span class="sxs-lookup"><span data-stu-id="24b5b-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="24b5b-140">İlk adım bir RecoveryManager örneği oluşturmaktır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-140">The first step is to create a RecoveryManager instance.</span></span> <span data-ttu-id="24b5b-141">[GetRecoveryManager yöntemi](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) geçerli kurtarma Yöneticisi döndürür [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) örneği.</span><span class="sxs-lookup"><span data-stu-id="24b5b-141">The [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns the recovery manager for the current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="24b5b-142">Parça eşleme bulunan tüm tutarsızlıkları çözmek için önce belirli parça harita RecoveryManager almanız gerekir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-142">To address any inconsistencies in the shard map, you must first retrieve the RecoveryManager for the particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="24b5b-143">Bu örnekte, RecoveryManager ShardMapManager başlatılır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-143">In this example, the RecoveryManager is initialized from the ShardMapManager.</span></span> <span data-ttu-id="24b5b-144">Bir ShardMap içeren ShardMapManager de zaten başlatılmış.</span><span class="sxs-lookup"><span data-stu-id="24b5b-144">The ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="24b5b-145">Bu uygulama kodu parça eşleme değiştirdiğinde bu yana (önceki örnekte, smmConnectionString) Fabrika yönteminde kullanılan kimlik bilgileri bağlantı dizesi tarafından başvurulan GSM veritabanı üzerinde okuma-yazma izinlerine sahip kimlik bilgileri olmalıdır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-145">Since this application code manipulates the shard map itself, the credentials used in the factory method (in the preceding example, smmConnectionString) should be credentials that have read-write permissions on the GSM database referenced by the connection string.</span></span> <span data-ttu-id="24b5b-146">Bu kimlik bilgileri, veri bağımlı yönlendirme bağlantıları'nı açmak için kullanılan kimlik bilgileri genellikle farklıdır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-146">These credentials are typically different from credentials used to open connections for data-dependent routing.</span></span> <span data-ttu-id="24b5b-147">Daha fazla bilgi için bkz: [esnek veritabanı istemci kimlik bilgilerini kullanarak](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="24b5b-147">For more information, see [Using credentials in the elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-the-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="24b5b-148">Bir parça silindikten sonra bir parça ShardMap kaldırma</span><span class="sxs-lookup"><span data-stu-id="24b5b-148">Removing a shard from the ShardMap after a shard is deleted</span></span>
<span data-ttu-id="24b5b-149">[DetachShard yöntemi](https://msdn.microsoft.com/library/azure/dn842083.aspx) verilen parça parça eşlemesinden ayırır ve parça ile ilişkili eşlemeleri siler.</span><span class="sxs-lookup"><span data-stu-id="24b5b-149">The [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches the given shard from the shard map and deletes mappings associated with the shard.</span></span>  

* <span data-ttu-id="24b5b-150">Konum parametresi parça, özellikle sunucu adını ve veritabanı adını ayrılmakta parça konumdur.</span><span class="sxs-lookup"><span data-stu-id="24b5b-150">The location parameter is the shard location, specifically server name and database name, of the shard being detached.</span></span> 
* <span data-ttu-id="24b5b-151">Parça eşleme adı shardMapName parametresidir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-151">The shardMapName parameter is the shard map name.</span></span> <span data-ttu-id="24b5b-152">Bu yalnızca olan birden çok parça eşlemesi aynı parça eşleme Yöneticisi tarafından yönetilen gereklidir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-152">This is only required when multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="24b5b-153">İsteğe bağlı.</span><span class="sxs-lookup"><span data-stu-id="24b5b-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="24b5b-154">Eminseniz, aralığın güncelleştirilmiş eşlemesi için boş ise yalnızca bu tekniği kullanın.</span><span class="sxs-lookup"><span data-stu-id="24b5b-154">Use this technique only if you are certain that the range for the updated mapping is empty.</span></span> <span data-ttu-id="24b5b-155">Denetimleri kodunuzda dahil etmek en iyisidir yukarıdaki yöntemleri taşınan, aralığı için veri denetlemez.</span><span class="sxs-lookup"><span data-stu-id="24b5b-155">The methods above do not check data for the range being moved, so it is best to include checks in your code.</span></span>
>

<span data-ttu-id="24b5b-156">Bu örnek parça parça eşlemesinden kaldırır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-156">This example removes shards from the shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="24b5b-157">Parça eşleme parça silinmesini önce GSM parça konumda yansıtır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-157">The shard map reflects the shard location in the GSM before the deletion of the shard.</span></span> <span data-ttu-id="24b5b-158">Parça silindiği için bu kasıtlı ve parçalama anahtar aralığı artık kullanımda varsayılır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-158">Because the shard was deleted, it is assumed this was intentional, and the sharding key range is no longer in use.</span></span> <span data-ttu-id="24b5b-159">Aksi durumda, zaman içinde nokta geri yükleme yürütebilir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="24b5b-160">bir önceki noktası zaman parça kurtarılır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-160">to recover the shard from an earlier point-in-time.</span></span> <span data-ttu-id="24b5b-161">(Bu durumda, parça tutarsızlıklar algılamak için aşağıdaki bölümü gözden geçirin.) Kurtarmak için bkz: [zaman kurtarma noktası](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="24b5b-161">(In that case, review the following section to detect shard inconsistencies.) To recover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="24b5b-162">Veritabanı silme kasıtlı varsayıldığından son yönetim temizleme eylemi parça parça eşleme Yöneticisi'nde girişe silmektir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-162">Since it is assumed the database deletion was intentional, the final administrative cleanup action is to delete the entry to the shard in the shard map manager.</span></span> <span data-ttu-id="24b5b-163">Bu, istemeden beklenmiyor bir aralık bilgi yazmasını uygulama engeller.</span><span class="sxs-lookup"><span data-stu-id="24b5b-163">This prevents the application from inadvertently writing information to a range that is not expected.</span></span>

## <a name="to-detect-mapping-differences"></a><span data-ttu-id="24b5b-164">Eşleme farklılıkları algılamak için</span><span class="sxs-lookup"><span data-stu-id="24b5b-164">To detect mapping differences</span></span>
<span data-ttu-id="24b5b-165">[DetectMappingDifferences yöntemi](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) seçer ve her iki parça eşlemeleri (GSM ve LSM) eşlemesi uzlaştırır parça eşlemeleri (yerel veya genel) gerçekte kaynağı olarak döndürür.</span><span class="sxs-lookup"><span data-stu-id="24b5b-165">The [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of the shard maps (either local or global) as the source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="24b5b-166">*Konumu* sunucu adını ve veritabanı adını belirtir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-166">The *location* specifies the server name and database name.</span></span> 
* <span data-ttu-id="24b5b-167">*ShardMapName* parametredir parça eşleme adı.</span><span class="sxs-lookup"><span data-stu-id="24b5b-167">The *shardMapName* parameter is the shard map name.</span></span> <span data-ttu-id="24b5b-168">Bu yalnızca olan birden çok parça eşlemesi aynı parça eşleme Yöneticisi tarafından yönetilen varsa gerekli.</span><span class="sxs-lookup"><span data-stu-id="24b5b-168">This is only required if multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="24b5b-169">İsteğe bağlı.</span><span class="sxs-lookup"><span data-stu-id="24b5b-169">Optional.</span></span> 

## <a name="to-resolve-mapping-differences"></a><span data-ttu-id="24b5b-170">Eşleme farkları gidermek için</span><span class="sxs-lookup"><span data-stu-id="24b5b-170">To resolve mapping differences</span></span>
<span data-ttu-id="24b5b-171">[ResolveMappingDifferences yöntemi](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) parça eşlemeleri (yerel veya genel) birini gerçekte kaynağı olarak seçer ve her iki parça eşlemeleri (GSM ve LSM) eşlemesi uzlaştırır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-171">The [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of the shard maps (either local or global) as the source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="24b5b-172">*RecoveryToken* parametre eşlemeleri GSM ve belirli parça LSM arasındaki farkları numaralandırır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-172">The *RecoveryToken* parameter enumerates the differences in the mappings between the GSM and the LSM for the specific shard.</span></span> 
* <span data-ttu-id="24b5b-173">[MappingDifferenceResolution numaralandırma](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) parça eşlemeleri arasındaki farkı çözmek için yöntem belirtmek için kullanılır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-173">The [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used to indicate the method for resolving the difference between the shard mappings.</span></span> 
* <span data-ttu-id="24b5b-174">**MappingDifferenceResolution.KeepShardMapping** LSM doğru eşleme içerdiğinde ve bu nedenle parça eşlemesindeki kullanılmalıdır önerilir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when the LSM contains the accurate mapping and therefore the mapping in the shard should be used.</span></span> <span data-ttu-id="24b5b-175">Bir yük devretme ise genellikle böyledir: parça şimdi yeni bir sunucuda bulunuyor.</span><span class="sxs-lookup"><span data-stu-id="24b5b-175">This is typically the case if there is a failover: the shard now resides on a new server.</span></span> <span data-ttu-id="24b5b-176">Parça (RecoveryManager.DetachShard yöntemi kullanılarak) GSM kaldırılmalıdır olduğundan, bir eşleme üzerinde GSM artık yok.</span><span class="sxs-lookup"><span data-stu-id="24b5b-176">Since the shard must first be removed from the GSM (using the RecoveryManager.DetachShard method), a mapping no longer exists on the GSM.</span></span> <span data-ttu-id="24b5b-177">Bu nedenle, LSM parça eşleme yeniden oluşturmak için kullanılması gerekir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-177">Therefore, the LSM must be used to re-establish the shard mapping.</span></span>

## <a name="attach-a-shard-to-the-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="24b5b-178">Bir parça geri yüklendikten sonra bir parça ShardMap ekleme</span><span class="sxs-lookup"><span data-stu-id="24b5b-178">Attach a shard to the ShardMap after a shard is restored</span></span>
<span data-ttu-id="24b5b-179">[AttachShard yöntemi](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) verilen parça parça eşlemesi ekler.</span><span class="sxs-lookup"><span data-stu-id="24b5b-179">The [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches the given shard to the shard map.</span></span> <span data-ttu-id="24b5b-180">Parça eşleme tutarsızlıkları algılar ve eşlemeleri parça parça geri yükleme noktasında eşleşecek şekilde güncelleştirir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-180">It then detects any shard map inconsistencies and updates the mappings to match the shard at the point of the shard restoration.</span></span> <span data-ttu-id="24b5b-181">Zaman içinde nokta geri yükleme damgasıyla eklenen yeni bir veritabanı için varsayılan olarak bu yana veritabanı (parça geri önce) özgün veritabanı adı, yansıtmak üzere de adlandırılır varsayılır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-181">It is assumed that the database is also renamed to reflect the original database name (before the shard was restored), since the point-in time restoration defaults to a new database appended with the timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="24b5b-182">*Konumu* parametredir sunucu adını ve veritabanı adını iliştirilmekte parça.</span><span class="sxs-lookup"><span data-stu-id="24b5b-182">The *location* parameter is the server name and database name, of the shard being attached.</span></span> 
* <span data-ttu-id="24b5b-183">*ShardMapName* parametredir parça eşleme adı.</span><span class="sxs-lookup"><span data-stu-id="24b5b-183">The *shardMapName* parameter is the shard map name.</span></span> <span data-ttu-id="24b5b-184">Bu yalnızca olan birden çok parça eşlemesi aynı parça eşleme Yöneticisi tarafından yönetilen gereklidir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-184">This is only required when multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="24b5b-185">İsteğe bağlı.</span><span class="sxs-lookup"><span data-stu-id="24b5b-185">Optional.</span></span> 

<span data-ttu-id="24b5b-186">Bu örnek önceki noktası-zaman bir yakın zamanda geri parça eşleme bir parça ekler.</span><span class="sxs-lookup"><span data-stu-id="24b5b-186">This example adds a shard to the shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="24b5b-187">(Yani LSM içinde parça için eşleme) parça geri olduğundan, büyük olasılıkla tutarsız GSM parça girişle kalır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-187">Since the shard (namely the mapping for the shard in the LSM) has been restored, it is potentially inconsistent with the shard entry in the GSM.</span></span> <span data-ttu-id="24b5b-188">Bu örnek kod dışında parça geri ve veritabanını özgün adına yeniden adlandırıldı.</span><span class="sxs-lookup"><span data-stu-id="24b5b-188">Outside of this example code, the shard was restored and renamed to the original name of the database.</span></span> <span data-ttu-id="24b5b-189">Geri yüklenen olduğundan, güvenilen eşleme eşleme LSM içinde olduğu varsayılır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-189">Since it was restored, it is assumed the mapping in the LSM is the trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-the-shards"></a><span data-ttu-id="24b5b-190">Bir coğrafi-yük devretme (geri yükleme) parça parça konumları güncelleştiriliyor</span><span class="sxs-lookup"><span data-stu-id="24b5b-190">Updating shard locations after a geo-failover (restore) of the shards</span></span>
<span data-ttu-id="24b5b-191">Bir yük devretme coğrafi varsa, ikincil veritabanı yazma erişilebilir oluşturulur ve yeni birincil veritabanı haline gelir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-191">If there is a geo-failover, the secondary database is made write accessible and becomes the new primary database.</span></span> <span data-ttu-id="24b5b-192">Sunucu ve büyük olasılıkla (yapılandırmanıza bağlı olarak), veritabanı adını, özgün birincil sunucudan farklı olabilir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-192">The name of the server, and potentially the database (depending on your configuration), may be different from the original primary.</span></span> <span data-ttu-id="24b5b-193">Bu nedenle GSM ve LSM parça eşleme girdileri düzeltilmelidir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-193">Therefore the mapping entries for the shard in the GSM and LSM must be fixed.</span></span> <span data-ttu-id="24b5b-194">Benzer şekilde, zaman içinde veritabanı farklı bir ad veya konum veya daha önceki bir noktaya geri yüklenirse, bu tutarsızlıkları parça eşlemelerinin neden olabilir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-194">Similarly, if the database is restored to a different name or location, or to an earlier point in time, this might cause inconsistencies in the shard maps.</span></span> <span data-ttu-id="24b5b-195">Parça eşleme Yöneticisi'nin doğru veritabanı açık bağlantıları dağıtım işleme.</span><span class="sxs-lookup"><span data-stu-id="24b5b-195">The Shard Map Manager handles the distribution of open connections to the correct database.</span></span> <span data-ttu-id="24b5b-196">Dağıtım parça eşleme ve uygulamaları isteği hedefidir parçalama anahtarının değerini veriler temel alır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-196">Distribution is based on the data in the shard map and the value of the sharding key that is the target of the applications request.</span></span> <span data-ttu-id="24b5b-197">Coğrafi-yük devretme sonrasında, bu bilgileri doğru sunucu adını, veritabanı adının ve kurtarılan veritabanının parça eşleme ile güncelleştirilmesi gerekir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-197">After a geo-failover, this information must be updated with the accurate server name, database name and shard mapping of the recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="24b5b-198">En iyi uygulamalar</span><span class="sxs-lookup"><span data-stu-id="24b5b-198">Best practices</span></span>
<span data-ttu-id="24b5b-199">Coğrafi yük devretme ve kurtarma genellikle kasıtlı olarak Azure SQL veritabanları iş sürekliliği özellikleri birini kullanan uygulaması bir bulut Yöneticisi tarafından yönetilen işlemleridir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-199">Geo-failover and recovery are operations typically managed by a cloud administrator of the application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="24b5b-200">İş sürekliliği planlama işlemleri, yordamlar ve işletme işlemleri kesintisiz devam etmesini sağlamak için ölçümleri gerektirir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-200">Business continuity planning requires processes, procedures, and measures to ensure that business operations can continue without interruption.</span></span> <span data-ttu-id="24b5b-201">GSM ve LSM güncel tutulduğundan emin olmak için bu iş akışı içinde kullanılmalıdır RecoveryManager sınıfı bir parçası olarak kullanılabilir yöntemleri gerçekleştirilen kurtarma eylemi temel.</span><span class="sxs-lookup"><span data-stu-id="24b5b-201">The methods available as part of the RecoveryManager class should be used within this work flow to ensure the GSM and LSM are kept up-to-date based on the recovery action taken.</span></span> <span data-ttu-id="24b5b-202">GSM ve LSM bir yük devretme olayından sonra doğru bilgileri yansıtacak düzgün şekilde sağlamak için beş temel adımı vardır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-202">There are five basic steps to properly ensuring the GSM and LSM reflect the accurate information after a failover event.</span></span> <span data-ttu-id="24b5b-203">Bu adımları yürütmek için uygulama kodu mevcut araçlar ve iş akışı tümleştirilebilir.</span><span class="sxs-lookup"><span data-stu-id="24b5b-203">The application code to execute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="24b5b-204">RecoveryManager ShardMapManager alın.</span><span class="sxs-lookup"><span data-stu-id="24b5b-204">Retrieve the RecoveryManager from the ShardMapManager.</span></span> 
2. <span data-ttu-id="24b5b-205">Eski parça parça eşlemesinden kullanımdan çıkarın.</span><span class="sxs-lookup"><span data-stu-id="24b5b-205">Detach the old shard from the shard map.</span></span>
3. <span data-ttu-id="24b5b-206">Yeni parça parça konuma dahil olmak üzere parça eşlemeye ekleyin.</span><span class="sxs-lookup"><span data-stu-id="24b5b-206">Attach the new shard to the shard map, including the new shard location.</span></span>
4. <span data-ttu-id="24b5b-207">GSM LSM arasındaki eşlemesinde tutarsızlıklarını algıla.</span><span class="sxs-lookup"><span data-stu-id="24b5b-207">Detect inconsistencies in the mapping between the GSM and LSM.</span></span> 
5. <span data-ttu-id="24b5b-208">GSM ve LSM güvenen LSM arasındaki farklılıkları giderin.</span><span class="sxs-lookup"><span data-stu-id="24b5b-208">Resolve differences between the GSM and the LSM, trusting the LSM.</span></span> 

<span data-ttu-id="24b5b-209">Bu örnekte aşağıdaki adımları gerçekleştirir:</span><span class="sxs-lookup"><span data-stu-id="24b5b-209">This example performs the following steps:</span></span>

1. <span data-ttu-id="24b5b-210">Parça parça konumlarını yük devretme olayından önce gösterecek parça eşleme kaldırır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-210">Removes shards from the Shard Map that reflect shard locations before the failover event.</span></span>
2. <span data-ttu-id="24b5b-211">Parça parça ("Configuration.SecondaryServer" yeni sunucu adı aynı veritabanı adında ancak parametredir) yeni parça konumlar yansıtma eşlemesi ekler.</span><span class="sxs-lookup"><span data-stu-id="24b5b-211">Attaches shards to the Shard Map reflecting the new shard locations (the parameter "Configuration.SecondaryServer" is the new server name but the same database name).</span></span>
3. <span data-ttu-id="24b5b-212">GSM ve her parça LSM arasındaki eşleme farkları algılayarak kurtarma belirteçlerini alır.</span><span class="sxs-lookup"><span data-stu-id="24b5b-212">Retrieves the recovery tokens by detecting mapping differences between the GSM and the LSM for each shard.</span></span> 
4. <span data-ttu-id="24b5b-213">Her parça LSM eşlemesinden güvenerek tutarsızlıklar çözümler.</span><span class="sxs-lookup"><span data-stu-id="24b5b-213">Resolves the inconsistencies by trusting the mapping from the LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

