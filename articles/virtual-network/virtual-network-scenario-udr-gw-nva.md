---
title: "2 katmanlı uygulama ile karma bağlantı | Microsoft Docs"
description: "Sanal gereçler ve Azure'da çok katmanlı uygulama ortamı oluşturmak için UDR dağıtmayı öğrenin"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 8e464348660114f5e99b4739bb7761b7e53ebf99
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 07/11/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="9857f-103">Sanal gereç senaryosu</span><span class="sxs-lookup"><span data-stu-id="9857f-103">Virtual appliance scenario</span></span>
<span data-ttu-id="9857f-104">Yaygın bir senaryo büyük Azure müşteri arasında Internet'e erişim geri katmanı için bir şirket içi veri merkezinden verirken açık iki katmanlı bir uygulama sağlamanız gerekiyor.</span><span class="sxs-lookup"><span data-stu-id="9857f-104">A common scenario among larger Azure customer is the need to provide a two-tiered application exposed to the Internet, while allowing access to the back tier from an on-premises datacenter.</span></span> <span data-ttu-id="9857f-105">Bu belge aşağıdaki gereksinimleri karşılayan iki katmanlı bir ortam dağıtmak için kullanıcı tanımlı yolları (UDR), bir VPN ağ geçidi ve ağ sanal Gereçleri kullanma bir senaryo yol gösterecek:</span><span class="sxs-lookup"><span data-stu-id="9857f-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances to deploy a two-tier environment that meets the following requirements:</span></span>

* <span data-ttu-id="9857f-106">Web uygulaması yalnızca ortak Internet üzerinden erişilebilir olması gerekir.</span><span class="sxs-lookup"><span data-stu-id="9857f-106">Web application must be accessible from the public Internet only.</span></span>
* <span data-ttu-id="9857f-107">Uygulamayı barındıran web sunucusunun bir arka uç uygulama sunucusu erişebilir olması gerekir.</span><span class="sxs-lookup"><span data-stu-id="9857f-107">Web server hosting the application must be able to access a backend application server.</span></span>
* <span data-ttu-id="9857f-108">Web uygulaması Internet'ten gelen tüm trafiği bir güvenlik duvarı sanal gereç aracılığıyla gitmeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="9857f-108">All traffic from the Internet to the web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="9857f-109">Bu sanal gereç yalnızca Internet trafiği için kullanılır.</span><span class="sxs-lookup"><span data-stu-id="9857f-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="9857f-110">Uygulama sunucusuna giden tüm trafiği bir güvenlik duvarı sanal gereç aracılığıyla gitmeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="9857f-110">All traffic going to the application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="9857f-111">Bu sanal gereç, arka uç sunucu erişimi ve VPN ağ geçidi şirket içi ağdan gelen erişim için kullanılır.</span><span class="sxs-lookup"><span data-stu-id="9857f-111">This virtual appliance will be used for access to the backend end server, and access coming in from the on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="9857f-112">Yöneticiler, şirket içi bilgisayarlarından güvenlik duvarı sanal gereçler yönetebilmek için, üçüncü bir güvenlik duvarı kullanarak özel yönetim amacıyla kullanılan sanal gereç.</span><span class="sxs-lookup"><span data-stu-id="9857f-112">Administrators must be able to manage the firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="9857f-113">Bu standart DMZ DMZ ve korumalı ağ ile bir senaryodur.</span><span class="sxs-lookup"><span data-stu-id="9857f-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="9857f-114">Bu senaryo, Azure'da Nsg'ler, güvenlik duvarı sanal gereçler veya her ikisinin birleşimini kullanarak oluşturulabilir.</span><span class="sxs-lookup"><span data-stu-id="9857f-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="9857f-115">Aşağıdaki tablo bazı Artıları ve eksileri Nsg'ler ve güvenlik duvarı sanal gereçler arasında gösterir.</span><span class="sxs-lookup"><span data-stu-id="9857f-115">The table below shows some of the pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="9857f-116">Uzmanları</span><span class="sxs-lookup"><span data-stu-id="9857f-116">Pros</span></span> | <span data-ttu-id="9857f-117">Simgeler</span><span class="sxs-lookup"><span data-stu-id="9857f-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="9857f-118">NSG</span><span class="sxs-lookup"><span data-stu-id="9857f-118">NSG</span></span> |<span data-ttu-id="9857f-119">Ücret ödemeden.</span><span class="sxs-lookup"><span data-stu-id="9857f-119">No cost.</span></span> <br/><span data-ttu-id="9857f-120">Azure RBAC ile tümleşik.</span><span class="sxs-lookup"><span data-stu-id="9857f-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="9857f-121">ARM şablonlarını kuralları oluşturulabilir.</span><span class="sxs-lookup"><span data-stu-id="9857f-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="9857f-122">Karmaşıklık büyük ortamlarda değişiklik yapacaktır.</span><span class="sxs-lookup"><span data-stu-id="9857f-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="9857f-123">Güvenlik duvarı</span><span class="sxs-lookup"><span data-stu-id="9857f-123">Firewall</span></span> |<span data-ttu-id="9857f-124">Veri düzlemi üzerinde tam denetim.</span><span class="sxs-lookup"><span data-stu-id="9857f-124">Full control over data plane.</span></span> <br/><span data-ttu-id="9857f-125">Güvenlik Duvarı konsolunu aracılığıyla merkezi yönetimi.</span><span class="sxs-lookup"><span data-stu-id="9857f-125">Central management through firewall console.</span></span> |<span data-ttu-id="9857f-126">Güvenlik Duvarı gerecini maliyeti.</span><span class="sxs-lookup"><span data-stu-id="9857f-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="9857f-127">Azure RBAC ile tümleşik değildir.</span><span class="sxs-lookup"><span data-stu-id="9857f-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="9857f-128">Çözüm DMZ ve korumalı ağ senaryosunu uygulamak için güvenlik duvarı sanal gereçler kullanır.</span><span class="sxs-lookup"><span data-stu-id="9857f-128">The solution below uses firewall virtual appliances to implement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="9857f-129">Dikkat edilmesi gerekenler</span><span class="sxs-lookup"><span data-stu-id="9857f-129">Considerations</span></span>
<span data-ttu-id="9857f-130">Bugün, aşağıdaki gibi farklı özellikler kullanılabilir kullanarak Azure'da yukarıda açıklanan ortamı dağıtabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="9857f-130">You can deploy the environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="9857f-131">**Sanal ağ (VNet)**.</span><span class="sxs-lookup"><span data-stu-id="9857f-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="9857f-132">Bir Azure sanal bir şirket içi ağ ile benzer şekilde davranır ve trafik yalıtımı ve sorunları ayrılması sağlamak için bir veya daha fazla alt bölümlenmiş.</span><span class="sxs-lookup"><span data-stu-id="9857f-132">An Azure VNet acts in similar fashion to an on-premises network, and can be segmented into one or more subnets to provide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="9857f-133">**Sanal gereç**.</span><span class="sxs-lookup"><span data-stu-id="9857f-133">**Virtual appliance**.</span></span> <span data-ttu-id="9857f-134">Birkaç iş ortakları, yukarıda açıklanan üç güvenlik duvarları için kullanılan Azure markette sanal gereçler sağlar.</span><span class="sxs-lookup"><span data-stu-id="9857f-134">Several partners provide virtual appliances in the Azure Marketplace that can be used for the three firewalls described above.</span></span> 
* <span data-ttu-id="9857f-135">**Kullanıcı tanımlı yolları (UDR)**.</span><span class="sxs-lookup"><span data-stu-id="9857f-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="9857f-136">Yönlendirme tabloları bir sanal ağ içindeki paketlerin akışı denetlemek için Azure ağ tarafından kullanılan Udr'ler içerebilir.</span><span class="sxs-lookup"><span data-stu-id="9857f-136">Route tables can contain UDRs used by Azure networking to control the flow of packets within a VNet.</span></span> <span data-ttu-id="9857f-137">Bu yol tablolarını alt ağlara uygulanabilir.</span><span class="sxs-lookup"><span data-stu-id="9857f-137">These route tables can be applied to subnets.</span></span> <span data-ttu-id="9857f-138">Azure'da yeni özellikler de Azure VNet içinde bir sanal gereç karma bağlantı'dan gelen tüm trafiği iletme yeteneği sağlamak GatewaySubnet, bir yol tablosu uygulamak yeteneğidir.</span><span class="sxs-lookup"><span data-stu-id="9857f-138">One of the newest features in Azure is the ability to apply a route table to the GatewaySubnet, providing the ability to forward all traffic coming into the Azure VNet from a hybrid connection to a virtual appliance.</span></span>
* <span data-ttu-id="9857f-139">**IP iletimi**.</span><span class="sxs-lookup"><span data-stu-id="9857f-139">**IP Forwarding**.</span></span> <span data-ttu-id="9857f-140">Varsayılan olarak, Azure ağ altyapısı iletin sanal ağ arabirimi kartlarıyla (NIC) paketleri yalnızca paketin hedef IP adresi NIC IP adresini eşleşiyorsa.</span><span class="sxs-lookup"><span data-stu-id="9857f-140">By default, the Azure networking engine forward packets to virtual network interface cards (NICs) only if the packet destination IP address matches the NIC IP address.</span></span> <span data-ttu-id="9857f-141">Bu nedenle, bir UDR bir paket için belirli bir sanal gereç gönderilmelidir tanımlıyorsa, Azure ağ altyapısı o paketin bırakın.</span><span class="sxs-lookup"><span data-stu-id="9857f-141">Therefore, if a UDR defines that a packet must be sent to a given virtual appliance, the Azure networking engine would drop that packet.</span></span> <span data-ttu-id="9857f-142">Paketin paket için gerçek hedef değil bir VM (Bu durumda bir sanal gereç) teslim emin olmak için IP iletimi sanal Gereci için etkinleştirmeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="9857f-142">To ensure the packet is delivered to a VM (in this case a virtual appliance) that is not the actual destination for the packet, you need to enable IP Forwarding for the virtual appliance.</span></span>
* <span data-ttu-id="9857f-143">**Ağ güvenlik grupları (Nsg'ler)**.</span><span class="sxs-lookup"><span data-stu-id="9857f-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="9857f-144">Aşağıdaki örnek Nsg'ler kullanmak yapmaz, ancak daha fazla giden trafiği filtrelemek bu alt ağ ve NIC'ler filtrelemek için Nsg'ler alt ağları ve/veya NIC bu çözümde uygulanan kullanabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="9857f-144">The example below does not make use of NSGs, but you could use NSGs applied to the subnets and/or NICs in this solution to further filter the traffic in and out of those subnets and NICs.</span></span>

![IPv6 bağlantısı](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="9857f-146">Bu örnekte, aşağıdakileri içeren bir abonelik vardır:</span><span class="sxs-lookup"><span data-stu-id="9857f-146">In this example there is a subscription that contains the following:</span></span>

* <span data-ttu-id="9857f-147">şemada gösterilmez 2 kaynak grubu.</span><span class="sxs-lookup"><span data-stu-id="9857f-147">2 resource groups, not shown in the diagram.</span></span> 
  * <span data-ttu-id="9857f-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="9857f-148">**ONPREMRG**.</span></span> <span data-ttu-id="9857f-149">Bir şirket içi ağ benzetimini yapmak gerekli tüm kaynaklar içeriyor.</span><span class="sxs-lookup"><span data-stu-id="9857f-149">Contains all resources necessary to simulate an on-premises network.</span></span>
  * <span data-ttu-id="9857f-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="9857f-150">**AZURERG**.</span></span> <span data-ttu-id="9857f-151">Azure sanal ağ ortamınız için gerekli tüm kaynaklar içeriyor.</span><span class="sxs-lookup"><span data-stu-id="9857f-151">Contains all resources necessary for the Azure virtual network environment.</span></span> 
* <span data-ttu-id="9857f-152">Adlı bir VNet **onpremvnet** aşağıda listelenen bölümlenmiş bir şirket içi veri merkezi taklit etmek üzere kullanılır.</span><span class="sxs-lookup"><span data-stu-id="9857f-152">A VNet named **onpremvnet** used to mimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="9857f-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="9857f-153">**onpremsn1**.</span></span> <span data-ttu-id="9857f-154">Bir şirket içi sunucu taklit etmek üzere Ubuntu çalıştıran sanal makine (VM) içeren bir alt ağ.</span><span class="sxs-lookup"><span data-stu-id="9857f-154">Subnet containing a virtual machine (VM) running Ubuntu to mimic an on-premises server.</span></span>
  * <span data-ttu-id="9857f-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="9857f-155">**onpremsn2**.</span></span> <span data-ttu-id="9857f-156">Bir yönetici tarafından kullanılan bir şirket içi bilgisayarın taklit etmek üzere Ubuntu çalıştıran bir VM'de içeren alt ağ.</span><span class="sxs-lookup"><span data-stu-id="9857f-156">Subnet containing a VM running Ubuntu to mimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="9857f-157">Adlı bir güvenlik duvarı sanal Gereci yoktur **OPFW** üzerinde **onpremvnet** tünel korumak için kullanılan **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="9857f-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used to maintain a tunnel to **azurevnet**.</span></span>
* <span data-ttu-id="9857f-158">Adlı bir VNet **azurevnet** aşağıda listelenen bölümlenmiş.</span><span class="sxs-lookup"><span data-stu-id="9857f-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="9857f-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="9857f-159">**azsn1**.</span></span> <span data-ttu-id="9857f-160">Dış güvenlik duvarı alt ağı yalnızca dış güvenlik duvarı için kullanılır.</span><span class="sxs-lookup"><span data-stu-id="9857f-160">External firewall subnet used exclusively for the external firewall.</span></span> <span data-ttu-id="9857f-161">Tüm Internet trafiğini bu alt ağ ile birlikte gelir.</span><span class="sxs-lookup"><span data-stu-id="9857f-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="9857f-162">Bu alt ağ yalnızca dış Güvenlik Duvarı'na bağlı bir NIC içerir.</span><span class="sxs-lookup"><span data-stu-id="9857f-162">This subnet only contains a NIC linked to the external firewall.</span></span>
  * <span data-ttu-id="9857f-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="9857f-163">**azsn2**.</span></span> <span data-ttu-id="9857f-164">Internet üzerinden erişilen bir web sunucusu olarak çalışan bir VM barındıran ön uç alt.</span><span class="sxs-lookup"><span data-stu-id="9857f-164">Front end subnet hosting a VM running as a web server that will be accessed from the Internet.</span></span>
  * <span data-ttu-id="9857f-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="9857f-165">**azsn3**.</span></span> <span data-ttu-id="9857f-166">Arka uç alt ağ ön uç web sunucusu tarafından erişilecek bir arka uç uygulama sunucusu çalıştıran bir VM'de barındırma.</span><span class="sxs-lookup"><span data-stu-id="9857f-166">Backend subnet hosting a VM running a backend application server that will be accessed by the front end web server.</span></span>
  * <span data-ttu-id="9857f-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="9857f-167">**azsn4**.</span></span> <span data-ttu-id="9857f-168">Yönetim alt ağı yalnızca tüm güvenlik duvarı sanal gereçler yönetim erişim sağlamak için kullanılır.</span><span class="sxs-lookup"><span data-stu-id="9857f-168">Management subnet used exclusively to provide management access to all firewall virtual appliances.</span></span> <span data-ttu-id="9857f-169">Bu alt ağ yalnızca çözümde kullanılan her güvenlik duvarı sanal Gereci için bir NIC içerir.</span><span class="sxs-lookup"><span data-stu-id="9857f-169">This subnet only contains a NIC for each firewall virtual appliance used in the solution.</span></span>
  * <span data-ttu-id="9857f-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="9857f-170">**GatewaySubnet**.</span></span> <span data-ttu-id="9857f-171">Azure karma bağlantı alt ağı ExpressRoute ve VPN ağ geçidi için Azure sanal ağlar ve diğer ağlar arasında bağlantı sağlamak için gereklidir.</span><span class="sxs-lookup"><span data-stu-id="9857f-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway to provide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="9857f-172">3 güvenlik duvarı sanal gereçler içinde vardır **azurevnet** ağ.</span><span class="sxs-lookup"><span data-stu-id="9857f-172">There are 3 firewall virtual appliances in the **azurevnet** network.</span></span> 
  * <span data-ttu-id="9857f-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="9857f-173">**AZF1**.</span></span> <span data-ttu-id="9857f-174">Azure'da genel IP adresi kaynağı kullanarak genel Internet'e açık dış güvenlik duvarı.</span><span class="sxs-lookup"><span data-stu-id="9857f-174">External firewall exposed to the public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="9857f-175">Bir şablon marketten ya da doğrudan satıcınızdan gereç, bu hükümleri 3-NIC sanal gereç elinizde emin olmanız gerekir.</span><span class="sxs-lookup"><span data-stu-id="9857f-175">You need to ensure you have a template from the Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="9857f-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="9857f-176">**AZF2**.</span></span> <span data-ttu-id="9857f-177">Arasındaki trafiği denetlemek için kullanılan iç güvenlik duvarı **azsn2** ve **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="9857f-177">Internal firewall used to control traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="9857f-178">Bu, 3-NIC sanal gereç de geçerlidir.</span><span class="sxs-lookup"><span data-stu-id="9857f-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="9857f-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="9857f-179">**AZF3**.</span></span> <span data-ttu-id="9857f-180">Yönetim ve güvenlik duvarı erişilebilir Yöneticiler için şirket içi veri merkezi, tüm güvenlik duvarı Gereçleri yönetmek için kullanılan bir yönetim alt ağına bağlı.</span><span class="sxs-lookup"><span data-stu-id="9857f-180">Management firewall accessible to administrators from the on-premises datacenter, and connected to a management subnet used to manage all firewall appliances.</span></span> <span data-ttu-id="9857f-181">2 NIC sanal gereç şablonları markette bulunamadı veya doğrudan Gereci satıcınızdan isteyin.</span><span class="sxs-lookup"><span data-stu-id="9857f-181">You can find 2-NIC virtual appliance templates in the Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="9857f-182">Kullanıcı tanımlı yönlendirme (UDR)</span><span class="sxs-lookup"><span data-stu-id="9857f-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="9857f-183">Azure her alt ağ trafiği alt yönlendirildiği nasıl başlatılan tanımlamak için kullanılan bir UDR tabloya bağlanabilir.</span><span class="sxs-lookup"><span data-stu-id="9857f-183">Each subnet in Azure can be linked to a UDR table used to define how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="9857f-184">Hiçbir Udr'ler tanımlanmışsa, Azure bir alt ağdan diğerine akışına izin vermek için varsayılan yolları kullanır.</span><span class="sxs-lookup"><span data-stu-id="9857f-184">If no UDRs are defined, Azure uses default routes to allow traffic to flow from one subnet to another.</span></span> <span data-ttu-id="9857f-185">Udr'ler daha iyi anlamak için ziyaret [kullanıcı tanımlı yollar ve IP iletimi nedir](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="9857f-185">To better understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="9857f-186">Yukarıdaki son gereksinimi temel alan doğru güvenlik duvarı Gereci aracılığıyla iletişim yapılır emin olmak için Udr'ler de içeren aşağıdaki yol tablosu oluşturmanız gerekir **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="9857f-186">To ensure communication is done through the right firewall appliance, based on the last requirement above, you need to create the following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="9857f-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="9857f-187">azgwudr</span></span>
<span data-ttu-id="9857f-188">Bu senaryoda, şirket içinden Azure'a yalnızca trafiği bağlanarak güvenlik duvarları yönetmek için kullanılacak **AZF3**, ve trafik iç güvenlik duvarı üzerinden gitmelidir **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="9857f-188">In this scenario, the only traffic flowing from on-premises to Azure will be used to manage the firewalls by connecting to **AZF3**, and that traffic must go through the internal firewall, **AZF2**.</span></span> <span data-ttu-id="9857f-189">Bu nedenle, yalnızca bir rota gerekli **GatewaySubnet** aşağıda gösterildiği gibi.</span><span class="sxs-lookup"><span data-stu-id="9857f-189">Therefore, only one route is necessary in the **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="9857f-190">Hedef</span><span class="sxs-lookup"><span data-stu-id="9857f-190">Destination</span></span> | <span data-ttu-id="9857f-191">Sonraki atlama</span><span class="sxs-lookup"><span data-stu-id="9857f-191">Next hop</span></span> | <span data-ttu-id="9857f-192">Açıklama</span><span class="sxs-lookup"><span data-stu-id="9857f-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="9857f-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="9857f-193">10.0.4.0/24</span></span> |<span data-ttu-id="9857f-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="9857f-194">10.0.3.11</span></span> |<span data-ttu-id="9857f-195">Yönetimi Güvenlik Duvarı ulaşmak şirket içi trafiğe izin veren **AZF3**</span><span class="sxs-lookup"><span data-stu-id="9857f-195">Allows on-premises traffic to reach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="9857f-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="9857f-196">azsn2udr</span></span>
| <span data-ttu-id="9857f-197">Hedef</span><span class="sxs-lookup"><span data-stu-id="9857f-197">Destination</span></span> | <span data-ttu-id="9857f-198">Sonraki atlama</span><span class="sxs-lookup"><span data-stu-id="9857f-198">Next hop</span></span> | <span data-ttu-id="9857f-199">Açıklama</span><span class="sxs-lookup"><span data-stu-id="9857f-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="9857f-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="9857f-200">10.0.3.0/24</span></span> |<span data-ttu-id="9857f-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="9857f-201">10.0.2.11</span></span> |<span data-ttu-id="9857f-202">Uygulama sunucusu üzerinden barındırma arka uç alt ağ trafiğine izin verir **AZF2**</span><span class="sxs-lookup"><span data-stu-id="9857f-202">Allows traffic to the backend subnet hosting the application server through **AZF2**</span></span> |
| <span data-ttu-id="9857f-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="9857f-203">0.0.0.0/0</span></span> |<span data-ttu-id="9857f-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="9857f-204">10.0.2.10</span></span> |<span data-ttu-id="9857f-205">Aracılığıyla yönlendirilecek tüm trafiğe izin veren **AZF1**</span><span class="sxs-lookup"><span data-stu-id="9857f-205">Allows all other traffic to be routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="9857f-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="9857f-206">azsn3udr</span></span>
| <span data-ttu-id="9857f-207">Hedef</span><span class="sxs-lookup"><span data-stu-id="9857f-207">Destination</span></span> | <span data-ttu-id="9857f-208">Sonraki atlama</span><span class="sxs-lookup"><span data-stu-id="9857f-208">Next hop</span></span> | <span data-ttu-id="9857f-209">Açıklama</span><span class="sxs-lookup"><span data-stu-id="9857f-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="9857f-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="9857f-210">10.0.2.0/24</span></span> |<span data-ttu-id="9857f-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="9857f-211">10.0.3.10</span></span> |<span data-ttu-id="9857f-212">Trafiğine izin verir **azsn2** Web uygulaması sunucusundan akışına için **AZF2**</span><span class="sxs-lookup"><span data-stu-id="9857f-212">Allows traffic to **azsn2** to flow from app server to the webserver through **AZF2**</span></span> |

<span data-ttu-id="9857f-213">Ayrıca alt yol tablolarını oluşturmanıza gerek **onpremvnet** şirket içi veri merkezi taklit etmek üzere.</span><span class="sxs-lookup"><span data-stu-id="9857f-213">You also need to create route tables for the subnets in **onpremvnet** to mimic the on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="9857f-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="9857f-214">onpremsn1udr</span></span>
| <span data-ttu-id="9857f-215">Hedef</span><span class="sxs-lookup"><span data-stu-id="9857f-215">Destination</span></span> | <span data-ttu-id="9857f-216">Sonraki atlama</span><span class="sxs-lookup"><span data-stu-id="9857f-216">Next hop</span></span> | <span data-ttu-id="9857f-217">Açıklama</span><span class="sxs-lookup"><span data-stu-id="9857f-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="9857f-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="9857f-218">192.168.2.0/24</span></span> |<span data-ttu-id="9857f-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="9857f-219">192.168.1.4</span></span> |<span data-ttu-id="9857f-220">Trafiğine izin verir **onpremsn2** aracılığıyla **OPFW**</span><span class="sxs-lookup"><span data-stu-id="9857f-220">Allows traffic to **onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="9857f-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="9857f-221">onpremsn2udr</span></span>
| <span data-ttu-id="9857f-222">Hedef</span><span class="sxs-lookup"><span data-stu-id="9857f-222">Destination</span></span> | <span data-ttu-id="9857f-223">Sonraki atlama</span><span class="sxs-lookup"><span data-stu-id="9857f-223">Next hop</span></span> | <span data-ttu-id="9857f-224">Açıklama</span><span class="sxs-lookup"><span data-stu-id="9857f-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="9857f-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="9857f-225">10.0.3.0/24</span></span> |<span data-ttu-id="9857f-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="9857f-226">192.168.2.4</span></span> |<span data-ttu-id="9857f-227">Azure yedeklenen alt ağ trafiğine izin verir **OPFW**</span><span class="sxs-lookup"><span data-stu-id="9857f-227">Allows traffic to the backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="9857f-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="9857f-228">192.168.1.0/24</span></span> |<span data-ttu-id="9857f-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="9857f-229">192.168.2.4</span></span> |<span data-ttu-id="9857f-230">Trafiğine izin verir **onpremsn1** aracılığıyla **OPFW**</span><span class="sxs-lookup"><span data-stu-id="9857f-230">Allows traffic to **onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="9857f-231">IP İletimi</span><span class="sxs-lookup"><span data-stu-id="9857f-231">IP Forwarding</span></span>
<span data-ttu-id="9857f-232">UDR ve IP iletimini özelliklerdir kullanabileceğiniz bir Azure sanal ağ trafiğinin akışını denetlemek için kullanılacak sanal gereçler izin vermek için bir arada.</span><span class="sxs-lookup"><span data-stu-id="9857f-232">UDR and IP Forwarding are features that you can use in combination to allow virtual appliances to be used to control traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="9857f-233">Sanal gereç, güvenlik duvarı veya NAT cihazı gibi ağ trafiğini işlemek için kullanılan bir uygulamayı çalıştıran bir VM'den fazlası değildir.</span><span class="sxs-lookup"><span data-stu-id="9857f-233">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="9857f-234">Bu sanal gereç VM'si, kendisine yönelik olmayan gelen trafiği alabilmelidir.</span><span class="sxs-lookup"><span data-stu-id="9857f-234">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span></span> <span data-ttu-id="9857f-235">Bir VM'nin başka hedeflere yönelik trafiği alabilmesine izin vermek için VM'de IP İletimini etkinleştirmeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="9857f-235">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span></span> <span data-ttu-id="9857f-236">Bu ayar konuk işletim sisteminin değil, Azure'ın bir ayarıdır.</span><span class="sxs-lookup"><span data-stu-id="9857f-236">This is an Azure setting, not a setting in the guest operating system.</span></span> <span data-ttu-id="9857f-237">Sanal gereç gelen trafiği işlemek ve uygun şekilde yönlendirmek için uygulamanın bazı türünü çalıştırmak hala gerekiyor.</span><span class="sxs-lookup"><span data-stu-id="9857f-237">Your virtual appliance still needs to run some type of application to handle the incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="9857f-238">IP iletimi hakkında daha fazla bilgi için [kullanıcı tanımlı yollar ve IP iletimi nedir](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="9857f-238">To learn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="9857f-239">Örnek olarak, bir Azure sanal aşağıdaki Kurulum olduğunu düşünün:</span><span class="sxs-lookup"><span data-stu-id="9857f-239">As an example, imagine you have the following setup in an Azure vnet:</span></span>

* <span data-ttu-id="9857f-240">Alt ağ **onpremsn1** adlı bir VM'den içeren **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="9857f-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="9857f-241">Alt ağ **onpremsn2** adlı bir VM'den içeren **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="9857f-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="9857f-242">Adlı bir sanal gereç **OPFW** bağlı **onpremsn1** ve **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="9857f-242">A virtual appliance named **OPFW** is connected to **onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="9857f-243">Bir kullanıcı tanımlı yol bağlı **onpremsn1** tüm için trafiği belirtir **onpremsn2** gönderilmelidir **OPFW**.</span><span class="sxs-lookup"><span data-stu-id="9857f-243">A user defined route linked to **onpremsn1** specifies that all traffic to **onpremsn2** must be sent to **OPFW**.</span></span>

<span data-ttu-id="9857f-244">AT noktada, varsa **onpremvm1** ile bağlantı kurmaya **onpremvm2**UDR kullanılacak ve trafik gönderilecek **OPFW** sonraki atlama olarak.</span><span class="sxs-lookup"><span data-stu-id="9857f-244">At this point, if **onpremvm1** tries to establish a connection with **onpremvm2**, the UDR will be used and traffic will be sent to **OPFW** as the next hop.</span></span> <span data-ttu-id="9857f-245">Gerçek paket hedef değil değiştirilmiş olduğunu aklınızda tutun, hala yazacaktır **onpremvm2** hedefi.</span><span class="sxs-lookup"><span data-stu-id="9857f-245">Keep in mind that the actual packet destination is not being changed, it still says **onpremvm2** is the destination.</span></span> 

<span data-ttu-id="9857f-246">IP iletme için etkinleştirilmiş olmadan **OPFW**, yalnızca VM'ın IP adresi paket için hedef ise bir VM'ye gönderilmek üzere paketleri verdiğinden Azure sanal ağ mantığı paketleri bırakın.</span><span class="sxs-lookup"><span data-stu-id="9857f-246">Without IP Forwarding enabled for **OPFW**, the Azure virtual networking logic will drop the packets, since it only allows packets to be sent to a VM if the VM’s IP address is the destination for the packet.</span></span>

<span data-ttu-id="9857f-247">IP iletimi ile Azure sanal ağı mantığı paketleri OPFW için özgün hedef adresini değiştirmeden iletir.</span><span class="sxs-lookup"><span data-stu-id="9857f-247">With IP Forwarding, the Azure virtual network logic will forward the packets to OPFW, without changing its original destination address.</span></span> <span data-ttu-id="9857f-248">**OPFW** paketlerini işlemek ve bunlarla yapmanız gerekenler belirlemek gerekir.</span><span class="sxs-lookup"><span data-stu-id="9857f-248">**OPFW** must handle the packets and determine what to do with them.</span></span>

<span data-ttu-id="9857f-249">Bu senaryo için yukarıdaki çalışması için IP iletimi için nıc'lerde etkinleştirmelisiniz **OPFW**, **AZF1**, **AZF2**, ve **AZF3** yönlendirme için kullanılır (yönetimi alt ağa bağlı olanlar dışındaki tüm NIC'ler).</span><span class="sxs-lookup"><span data-stu-id="9857f-249">For the scenario above to work, you must enable IP Forwarding on the NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except the ones linked to the management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="9857f-250">Güvenlik Duvarı Kuralları</span><span class="sxs-lookup"><span data-stu-id="9857f-250">Firewall Rules</span></span>
<span data-ttu-id="9857f-251">Yukarıda açıklandığı gibi yalnızca IP iletimi sanal gereçler gönderilen paket sağlar.</span><span class="sxs-lookup"><span data-stu-id="9857f-251">As described above, IP Forwarding only ensures packets are sent to the virtual appliances.</span></span> <span data-ttu-id="9857f-252">Aygıtınızın hala bu paketleri ile Yapılacaklar karar vermeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="9857f-252">Your appliance still needs to decide what to do with those packets.</span></span> <span data-ttu-id="9857f-253">Yukarıdaki senaryoda, cihazları aşağıdaki kurallar oluşturmanız gerekir:</span><span class="sxs-lookup"><span data-stu-id="9857f-253">In the scenario above, you will need to create the following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="9857f-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="9857f-254">OPFW</span></span>
<span data-ttu-id="9857f-255">OPFW aşağıdaki kuralları içeren bir şirket içi aygıtını temsil eder:</span><span class="sxs-lookup"><span data-stu-id="9857f-255">OPFW represents an on-premises device containing the following rules:</span></span>

* <span data-ttu-id="9857f-256">**Rota**: 10.0.0.0/16 giden tüm trafiği (**azurevnet**) tünel üzerinden gönderilen **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="9857f-256">**Route**: All traffic to 10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="9857f-257">**İlke**: arasındaki tüm çift yönlü trafiğine izin **port2** ve **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="9857f-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="9857f-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="9857f-258">AZF1</span></span>
<span data-ttu-id="9857f-259">AZF1 aşağıdaki kuralları içeren bir Azure sanal Gereci temsil eder:</span><span class="sxs-lookup"><span data-stu-id="9857f-259">AZF1 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="9857f-260">**İlke**: arasındaki tüm çift yönlü trafiğine izin **port1** ve **port2**.</span><span class="sxs-lookup"><span data-stu-id="9857f-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="9857f-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="9857f-261">AZF2</span></span>
<span data-ttu-id="9857f-262">AZF2 aşağıdaki kuralları içeren bir Azure sanal Gereci temsil eder:</span><span class="sxs-lookup"><span data-stu-id="9857f-262">AZF2 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="9857f-263">**Rota**: 10.0.0.0/16 giden tüm trafiği (**onpremvnet**) için Azure ağ geçidi IP adresi (örneğin, 10.0.0.1) üzerinden gönderilmesi gereken **port1**.</span><span class="sxs-lookup"><span data-stu-id="9857f-263">**Route**: All traffic to 10.0.0.0/16 (**onpremvnet**) must be sent to the Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="9857f-264">**İlke**: arasındaki tüm çift yönlü trafiğine izin **port1** ve **port2**.</span><span class="sxs-lookup"><span data-stu-id="9857f-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="9857f-265">Ağ güvenlik grupları (Nsg'ler)</span><span class="sxs-lookup"><span data-stu-id="9857f-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="9857f-266">Bu senaryoda, Nsg'ler kullanılmayan.</span><span class="sxs-lookup"><span data-stu-id="9857f-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="9857f-267">Bununla birlikte, her alt ağa gelen ve giden trafiği kısıtlamak için Nsg'leri uygulayabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="9857f-267">However, you could apply NSGs to each subnet to restrict incoming and outgoing traffic.</span></span> <span data-ttu-id="9857f-268">Örneğin, aşağıdaki NSG kuralları dış FW alt ağına uygulayabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="9857f-268">For instance, you could apply the following NSG rules to the external FW subnet.</span></span>

<span data-ttu-id="9857f-269">**Gelen**</span><span class="sxs-lookup"><span data-stu-id="9857f-269">**Incoming**</span></span>

* <span data-ttu-id="9857f-270">Tüm TCP trafiğini Internet'ten alt ağdaki tüm VM üzerinde 80 numaralı bağlantı noktasına izin verin.</span><span class="sxs-lookup"><span data-stu-id="9857f-270">Allow all TCP traffic from the Internet to port 80 on any VM in the subnet.</span></span>
* <span data-ttu-id="9857f-271">Diğer tüm trafik, Internet'ten reddedin.</span><span class="sxs-lookup"><span data-stu-id="9857f-271">Deny all other traffic from the Internet.</span></span>

<span data-ttu-id="9857f-272">**Giden**</span><span class="sxs-lookup"><span data-stu-id="9857f-272">**Outgoing**</span></span>

* <span data-ttu-id="9857f-273">Tüm trafik Internet'e reddedin.</span><span class="sxs-lookup"><span data-stu-id="9857f-273">Deny all traffic to the Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="9857f-274">Yüksek düzey adımları</span><span class="sxs-lookup"><span data-stu-id="9857f-274">High level steps</span></span>
<span data-ttu-id="9857f-275">Bu senaryoyu dağıtmak için aşağıdaki üst düzey adımları izleyin.</span><span class="sxs-lookup"><span data-stu-id="9857f-275">To deploy this scenario, follow the high level steps below.</span></span>

1. <span data-ttu-id="9857f-276">Azure aboneliğinizde oturum açın.</span><span class="sxs-lookup"><span data-stu-id="9857f-276">Login to your Azure Subscription.</span></span>
2. <span data-ttu-id="9857f-277">Şirket içi ağını taklit etmek üzere bir Vnet'i dağıtmak istiyorsanız, parçası olan kaynakları sağlamak **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="9857f-277">If you want to deploy a VNet to mimic the on-premises network, provision the resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="9857f-278">Parçası olan kaynakları sağlamak **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="9857f-278">Provision the resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="9857f-279">Gelen Tünel sağlamak **onpremvnet** için **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="9857f-279">Provision the tunnel from **onpremvnet** to **azurevnet**.</span></span>
5. <span data-ttu-id="9857f-280">Tüm kaynaklar sağlandıktan sonra oturum **onpremvm2** ve 10.0.3.101 arasındaki bağlantıyı sınamak için ping **onpremsn2** ve **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="9857f-280">Once all resources are provisioned, log on to **onpremvm2** and ping 10.0.3.101 to test connectivity between **onpremsn2** and **azsn3**.</span></span>

